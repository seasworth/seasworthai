<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>seasworth.ai</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    --bg1: #0b0426;
    --bg2: #16082f;
    --accent1: #7a2bff;
    --accent2: #3a00ff;
    --glass: rgba(255, 255, 255, 0.04);
    --white-glow: rgba(255, 255, 255, 0.15);
    --neon: #b58cff;
    --green-neon: #00ff6a;
    --red-neon: #ff3b3b;
    --font-main: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  * { box-sizing: border-box; font-family: var(--font-main); }
  html, body { height: 100%; margin: 0; background: linear-gradient(180deg, var(--bg1), var(--bg2)); color: #eee; overflow: hidden; }
  a { color: var(--neon); text-decoration: none; }

  /* Main App Styles */
  .app { display: flex; height: 100vh; width: 100vw; gap: 18px; padding: 28px; align-items: stretch; }
  .sidebar { width: 300px; background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01)); border-radius: 18px; padding: 22px; border: 1px solid rgba(255, 255, 255, 0.03); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45); display: flex; flex-direction: column; gap: 14px; height: calc(100vh - 56px); opacity: 0; transform: translateX(-30px); animation: slideInLeft 0.8s cubic-bezier(.25, .8, .25, 1) forwards; }
  
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand .title { 
    font-size: 22px; 
    font-weight: 900; 
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .brand .robot-icon {
    width: 40px; height: 40px; position: relative;
    display: flex; align-items: center; justify-content: center;
  }
  .brand .robot-icon .robot, .brand .robot-icon .bg-box {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 10px;
  }
  .brand .robot-icon .robot {
    background: linear-gradient(135deg, var(--neon), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; z-index: 2;
    animation: rotate-fast 4s linear infinite;
  }
  .brand .robot-icon .bg-box {
    background: var(--accent1);
    opacity: 0.5;
    z-index: 1;
    animation: rotate-slow 6s linear infinite;
  }
  :root {
  --neon-purple: #7a2bff;
  --outline-purple: #7a2bff;
  }

  .status-orb {
    width: 100%;
    height: 100%;
    position: relative;
  }
  .orb-core {
    position: absolute;
    width: 24px;
    height: 24px;
    background: var(--neon-purple);
    border-radius: 4px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 25px var(--neon-purple), 0 0 50px var(--neon-purple), 0 0 75px var(--neon-purple);
    animation: rotate-core 3s linear infinite reverse;
  }
  @keyframes rotate-core {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to   { transform: translate(-50%, -50%) rotate(360deg); }
  }
  .orb-dot {
    position: absolute;
    width: 10px;
    height: 10px;
    background: var(--neon-purple);
    border-radius: 2px;
    box-shadow: 0 0 12px var(--neon-purple), 0 0 20px var(--outline-purple), 0 0 40px var(--outline-purple);
    top: 50%;
    left: 50%;
    margin: -6px 0 0 -6px;
  }
  .orb-dot:nth-child(2) { animation: orbit-breathe 4s linear infinite 0s; }
  .orb-dot:nth-child(3) { animation: orbit-breathe 4s linear infinite 0.7s; }
  .orb-dot:nth-child(4) { animation: orbit-breathe 4s linear infinite 1.2s; }
  @keyframes orbit-breathe {
    0%   { transform: rotate(0deg) translateX(25px) scale(1) rotate(0deg); }
    25%  { transform: rotate(90deg) translateX(25px) scale(0.7) rotate(-90deg); }
    55%  { transform: rotate(180deg) translateX(25px) scale(1) rotate(-180deg); }
    80%  { transform: rotate(270deg) translateX(25px) scale(0.7) rotate(-270deg); }
    100% { transform: rotate(360deg) translateX(25px) scale(1) rotate(-360deg); }
  }
  .new-chat-btn { width: 100%; padding: 12px; background: var(--accent1); color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .new-chat-btn:hover { background: var(--accent2); box-shadow: 0 0 15px -2px var(--accent1); }
  .chats { flex: 1; overflow-y: auto; padding-right: 8px; margin-top: 10px; }
  .chats h3 { margin: 8px 0 10px 4px; font-size: 15px; color: #ddd; font-weight: 700; }
  .chat-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition: all .18s; position: relative; }
  .chat-item.active, .chat-item:hover { transform: translateX(6px); background: var(--glass); border-color: rgba(255, 255, 255, 0.2); }
  .chat-item .title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
  .main { flex: 1; border-radius: 18px; position: relative; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45); overflow: hidden; opacity: 0; transform: translateY(30px); animation: slideInUp 0.8s 0.2s cubic-bezier(.25, .8, .25, 1) forwards; }
  .chat-area { flex: 1; overflow-y: auto; padding: 24px; background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.02)); display: flex; flex-direction: column; gap: 16px; }
  .input-area { padding: 24px; background: rgba(0,0,0,0.15); border-top: 1px solid rgba(255, 255, 255, 0.05); }
  .input-wrapper { display: flex; align-items: center; background: #2b2d31; border-radius: 12px; padding: 4px; border: 1px solid #4f4f52; }
  #chat-input { flex: 1; background: transparent; border: none; color: #fff; padding: 12px; font-size: 16px; outline: none; }
  #send-btn { padding: 10px 18px; background: var(--accent1); color: #fff; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
  #send-btn:hover { background: var(--accent2); }
  .message-bubble { max-width: 80%; padding: 14px 18px; border-radius: 16px; line-height: 1.6; word-wrap: break-word; }
  .user-message { background: var(--accent1); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
  .bot-message { background: #2f3136; color: #eee; align-self: flex-start; border-bottom-left-radius: 4px; }
  .bot-message pre { background: #1e1f22; padding: 12px; border-radius: 8px; overflow-x: auto; border: 1px solid #444; }
  .bot-message code { font-family: "Fira Code", monospace; font-size: 14px; }
  .bot-message p { margin: 0; }
  .bot-message ul, .bot-message ol { padding-left: 20px; }
  .bot-message li { margin-bottom: 6px; }
  .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 20px; }
  .welcome-screen .logo { font-size: 60px; margin-bottom: 20px; animation: pulse 2.5s infinite; }
  .welcome-screen h1 { font-size: 32px; font-weight: 800; color: #fff; margin-bottom: 10px; }
  .welcome-screen p { color: #ccc; max-width: 500px; margin-bottom: 30px; }
  #command-suggestions { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; width: 100%; max-width: 800px; }
  .command-card { background: var(--glass); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: all 0.2s; text-align: left; }
  .command-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); border-color: var(--accent1); }
  .command-card .cmd-title { font-weight: 700; color: var(--neon); }
  .command-card .cmd-desc { font-size: 14px; color: #bbb; }
  .sidebar-footer { padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; }
  .user-info { font-weight: 600; color: #fff; }
  #logout-btn { background: none; border: none; color: var(--red-neon); font-size: 15px; font-weight: 700; cursor: pointer; }
  @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes rotate-fast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
  @keyframes pulse { 0%, 100% { transform: scale(1); text-shadow: 0 0 10px var(--neon); } 50% { transform: scale(1.05); text-shadow: 0 0 25px var(--neon); } }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--accent1); border-radius: 99px; }
  .message-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
  }
  .action-btn {
      background: var(--accent2);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease-in-out;
  }
  .action-btn:hover {
      background: #681fff;
      box-shadow: 0 0 10px #681fff;
  }
  .action-btn.primary {
      background: var(--accent1);
  }
  .action-btn.primary:hover {
      background: #681fff;
      box-shadow: 0 0 15px #681fff;
  }
  .action-btn.primary:active {
      background: #681fff;
      color: #fff;
      box-shadow: 0 0 15px #681fff;
  }
  .action-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: #ccc;
  }
  .recipe-result {
      margin-top: 20px;
  }
  .recipe-content {
      background: #4a1a8a;
      border-radius: 12px;
      padding: 20px;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
  }
  .recipe-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
  }
  .loading-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--neon);
      animation: textPulse 2s ease-in-out infinite;
  }
  .delete-chat-btn {
      display: none;
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: white;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      padding: 0 5px;
      opacity: 0.7;
      transition: opacity 0.2s;
  }
  .chat-item:hover .delete-chat-btn { display: block; }
  .delete-chat-btn:hover { opacity: 1; text-shadow: 0 0 8px var(--red-neon); }
  .image-loader-container {
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      text-align: center;
  }
  .image-loader-animation {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 15px auto 0;
      border-radius: 12px;
      background: rgba(0,0,0,0.3);
      overflow: hidden;
  }
  .image-loader-box {
      position: absolute;
      width: 100px;
      height: 100px;
      background: var(--neon);
      box-shadow: 0 0 35px var(--neon);
      animation: moveBox 12s cubic-bezier(0.65, 0, 0.35, 1) infinite;
  }
  @keyframes moveBox {
      0% { top: 0; left: 0; border-radius: 50%; }
      25% { top: calc(100% - 100px); left: calc(100% - 100px); border-radius: 0; }
      50% { top: calc(100% - 100px); left: 0; border-radius: 50%; }
      75% { top: 0; left: calc(100% - 100px); border-radius: 0; }
      100% { top: 0; left: 0; border-radius: 50%; }
  }
  .command-builder {
      display: none;
      align-items: center;
      flex: 1;
      gap: 10px;
  }
  .command-builder .cmd-name { font-size: 16px; font-weight: 600; color: #fff; }
  .command-builder .param-input-box {
      display: flex;
      align-items: center;
      border: 1px solid #4f4f52;
      background: #2b2d31;
      border-radius: 6px;
      padding: 4px 8px;
      flex: 1;
  }
  .command-builder .param-input {
      background: transparent;
      border: none;
      outline: none;
      color: #fff;
      font-size: 16px;
      width: 100%;
  }
  .crypto-container .price-up, .crypto-list-item .price-up, .crypto-rec-card .price-up { color: var(--green-neon); }
  .crypto-container .price-down, .crypto-list-item .price-down, .crypto-rec-card .price-down { color: var(--red-neon); }
  .crypto-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
  .crypto-header h3 { margin: 0; }
  #crypto-refresh-btn { background: var(--accent1); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
  #crypto-refresh-btn.active { background: var(--green-neon); color: #000; }
  .crypto-recommendations { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
  .crypto-rec-card { background: rgba(255, 255, 255, 0.07); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid transparent; transition: all 0.2s ease-in-out; }
  .crypto-rec-card:hover { transform: translateY(-5px); border-color: var(--accent1); }
  .crypto-rec-card .crypto-icon { margin: 0 auto 10px auto; }
  .crypto-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
  .crypto-list::-webkit-scrollbar { width: 4px; }
  .crypto-list::-webkit-scrollbar-thumb { background: var(--accent1); border-radius: 999px; }
  .crypto-list-item { display: flex; align-items: center; padding: 10px; margin-bottom: 5px; border-radius: 8px; transition: background 0.2s; }
  .crypto-list-item:hover { background: var(--glass); }
  .crypto-info { flex-grow: 1; }
  .crypto-info .name { font-weight: bold; }
  .crypto-info .symbol { font-size: 0.9em; color: #aaa; }
  .crypto-price { text-align: right; }
  .crypto-price .price { font-weight: bold; }
  .crypto-price .change { font-size: 0.9em; }
  .whiteboard-container { border: 1px solid var(--accent1); border-radius: 12px; overflow: hidden; margin-top: 15px; }
  .whiteboard-header { background: rgba(0,0,0,0.3); padding: 10px; display: flex; justify-content: space-between; align-items: center; }
  .whiteboard-canvas-wrapper { position: relative; width: 100%; height: 500px; background: #f0f0f0; }
  .whiteboard-canvas { display: block; }
  .support-ticket-form { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; }
  .support-ticket-form h3 { margin-top: 0; }
  .support-ticket-form .form-group { margin-bottom: 15px; }
  .support-ticket-form label { display: block; margin-bottom: 5px; font-weight: 600; }
  .support-ticket-form input, .support-ticket-form textarea, .support-ticket-form select { width: 100%; padding: 10px; background: #2b2d31; border: 1px solid #4f4f52; border-radius: 8px; color: #fff; }
  .support-ticket-list { margin-top: 20px; }
  .ticket-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--accent1); }
  .ticket-card.priority-High { border-left-color: var(--red-neon); }
  .ticket-card.priority-Medium { border-left-color: #ffc107; }
  .ticket-card .ticket-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  .ticket-card .ticket-body { margin: 10px 0; }
  .ticket-card .ticket-footer { font-size: 0.9em; color: #aaa; display: flex; justify-content: space-between; align-items: center; }
  .ticket-actions button { margin-left: 10px; }
</style>

</head>
<body>

<!-- Main App Container -->
<div class="app">
  <div class="sidebar">
    <div class="brand">
      <div class="robot-icon">
        <div class="status-orb">
          <div class="orb-core"></div>
          <div class="orb-dot"></div>
          <div class="orb-dot"></div>
          <div class="orb-dot"></div>
        </div>
      </div>
      <span class="title">seasworth.ai</span>
    </div>
    <button class="new-chat-btn" id="new-chat-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      New Chat
    </button>
    <div class="chats" id="chats-list">
      <h3>Recent Chats</h3>
    </div>
    <div class="sidebar-footer">
      <span class="user-info" id="usernameDisplay">User</span>
      <button id="logout-btn">Logout</button>
    </div>
  </div>
  <div class="main">
    <div class="chat-area" id="chat-area">
      <div class="welcome-screen" id="welcome-screen">
        <div class="logo">🤖</div>
        <h1>Welcome to seasworth.ai</h1>
        <p>Your advanced AI assistant. Select a command below or type your query to get started.</p>
        <div id="command-suggestions"></div>
      </div>
    </div>
    <div class="input-area">
      <div class="input-wrapper">
        <div class="command-builder" id="command-builder">
          <span class="cmd-name" id="cmd-name-display"></span>
          <div class="param-input-box">
            <input type="text" id="param-input" placeholder="Enter parameter...">
          </div>
        </div>
        <input type="text" id="chat-input" placeholder="Type a message or command...">
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let chats = [];
    let activeChatId = null;
    let canvases = {}; // To store whiteboard instances
    let currentCommand = null;

    // --- DOM ELEMENTS ---
    const chatArea = document.getElementById('chat-area');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatsList = document.getElementById('chats-list');
    const welcomeScreen = document.getElementById('welcome-screen');
    const commandSuggestions = document.getElementById('command-suggestions');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const logoutBtn = document.getElementById('logout-btn');
    const commandBuilder = document.getElementById('command-builder');
    const paramInput = document.getElementById('param-input');
    const cmdNameDisplay = document.getElementById('cmd-name-display');

    // --- COMMANDS DEFINITION ---
    const commands = {
        'help': {
            title: 'Show Help',
            description: 'Displays all available commands and their uses.',
            params: [],
            handler: () => {
                const helpText = Object.entries(commands).map(([key, cmd]) => `<strong>/${key}</strong>: ${cmd.description}`).join('<br>');
                addMessageToChat('bot', `<div class="message-content"><h3>Available Commands</h3>${helpText}</div>`);
            }
        },
        'clear': {
            title: 'Clear Chat',
            description: 'Clears all messages from the current chat window.',
            params: [],
            handler: () => {
                const currentChat = chats.find(c => c.id === activeChatId);
                if (currentChat) {
                    currentChat.messages = [];
                    saveChats();
                    renderActiveChat();
                }
            }
        },
        'generate-image': {
            title: 'Generate Image',
            description: 'Creates an AI-generated image based on a prompt.',
            params: [{ name: 'prompt', placeholder: 'e.g., a futuristic city skyline' }],
            handler: handleImageCommand
        },
        'get-crypto-prices': {
            title: 'Crypto Prices',
            description: 'Fetches the latest prices for top cryptocurrencies.',
            params: [],
            handler: handleCryptoCommand
        },
        'get-recipe': {
            title: 'Find Recipe',
            description: 'Finds a recipe for a specified dish.',
            params: [{ name: 'dish', placeholder: 'e.g., spaghetti carbonara' }],
            handler: handleRecipeCommand
        },
        'start-whiteboard': {
            title: 'Start Whiteboard',
            description: 'Opens a collaborative whiteboard for drawing.',
            params: [{ name: 'topic', placeholder: 'e.g., Project Brainstorm' }],
            handler: handleWhiteboardCommand
        },
        'create-support-ticket': {
            title: 'Create Support Ticket',
            description: 'Opens a form to create a new support ticket.',
            params: [],
            handler: handleSupportTicketCommand,
            adminOnly: false
        },
        'view-support-tickets': {
            title: 'View Support Tickets',
            description: 'View all open support tickets (Admin only).',
            params: [],
            handler: loadSupportTickets,
            adminOnly: true
        }
    };

    // --- API & COMMAND HANDLERS ---
    async function handleImageCommand(prompt) {
        const messageId = `image-${Date.now()}`;
        addMessageToChat('bot', `<div class="message-content" id="${messageId}">
            <div class="image-loader-container">
                <p class="loading-text">🎨 Generating image of "${prompt}"...</p>
                <div class="image-loader-animation"><div class="image-loader-box"></div></div>
                <p>This may take a moment. Please wait.</p>
            </div>
        </div>`);
        try {
            const response = await fetch(`https://source.unsplash.com/512x512/?${encodeURIComponent(prompt)}`);
            if (!response.ok) throw new Error('Image not found.');
            const imageUrl = response.url;
            const targetElement = document.getElementById(messageId);
            targetElement.innerHTML = `
                <p>Here is the generated image for "${prompt}":</p>
                <img src="${imageUrl}" alt="${prompt}" style="max-width: 100%; border-radius: 12px; margin-top: 10px;">
            `;
        } catch (error) {
            const targetElement = document.getElementById(messageId);
            targetElement.innerHTML = `<p style="color: var(--red-neon);">❌ Error generating image: ${error.message}</p>`;
        }
    }

    async function handleCryptoCommand() {
        const messageId = `crypto-${Date.now()}`;
        addMessageToChat('bot', `<div class="message-content" id="${messageId}"><p class="loading-text">Fetching crypto data...</p></div>`);
        try {
            const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false');
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const data = await response.json();
            
            const recommendations = data.slice(0, 3).map(coin => `
                <div class="crypto-rec-card">
                    <img src="${coin.image}" alt="${coin.name}" width="40" class="crypto-icon">
                    <h4>${coin.name}</h4>
                    <div class="price">$${coin.current_price.toLocaleString()}</div>
                    <div class="change ${coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}">
                        ${coin.price_change_percentage_24h.toFixed(2)}%
                    </div>
                </div>
            `).join('');

            const cryptoList = data.map(coin => `
                <li class="crypto-list-item">
                    <img src="${coin.image}" alt="${coin.name}" width="30" style="margin-right: 12px;">
                    <div class="crypto-info">
                        <div class="name">${coin.name}</div>
                        <div class="symbol">${coin.symbol.toUpperCase()}</div>
                    </div>
                    <div class="crypto-price">
                        <div class="price">$${coin.current_price.toLocaleString()}</div>
                        <div class="change ${coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}">
                            ${coin.price_change_percentage_24h.toFixed(2)}%
                        </div>
                    </div>
                </li>
            `).join('');

            const targetElement = document.getElementById(messageId);
            targetElement.innerHTML = `
                <div class="crypto-container">
                    <div class="crypto-header">
                        <h3>📈 Top Crypto by Market Cap</h3>
                        <button id="crypto-refresh-btn" class="action-btn" onclick="window.refreshCrypto()">Refresh</button>
                    </div>
                    <div class="crypto-recommendations">${recommendations}</div>
                    <ul class="crypto-list">${cryptoList}</ul>
                </div>
            `;
        } catch (error) {
            const targetElement = document.getElementById(messageId);
            targetElement.innerHTML = `<p style="color: var(--red-neon);">❌ Error fetching crypto data: ${error.message}</p>`;
        }
    }
    window.refreshCrypto = () => {
        const refreshBtn = document.getElementById('crypto-refresh-btn');
        if (refreshBtn) {
            refreshBtn.textContent = 'Refreshing...';
            refreshBtn.classList.add('active');
            setTimeout(() => {
                handleCryptoCommand();
            }, 500);
        }
    };

    async function handleRecipeCommand(dish) {
        const messageId = `recipe-${Date.now()}`;
        addMessageToChat('bot', `<div class="message-content" id="${messageId}"><p class="loading-text">Searching for "${dish}" recipes...</p></div>`);
        try {
            const response = await fetch(`https://www.themealdb.com/api/json/v1/1/search.php?s=${dish}`);
            const data = await response.json();
            if (!data.meals) throw new Error('No recipes found for that dish.');
            
            const recipe = data.meals[0];
            const ingredients = [];
            for (let i = 1; i <= 20; i++) {
                if (recipe[`strIngredient${i}`]) {
                    ingredients.push(`<li>${recipe[`strIngredient${i}`]} - ${recipe[`strMeasure${i}`]}</li>`);
                } else {
                    break;
                }
            }

            const recipeHtml = `
                <h3>${recipe.strMeal}</h3>
                <img src="${recipe.strMealThumb}" alt="${recipe.strMeal}" style="width:100%; max-width: 400px; border-radius: 12px;">
                <h4>Ingredients</h4>
                <ul>${ingredients.join('')}</ul>
                <h4>Instructions</h4>
                <p>${recipe.strInstructions.replace(/\r\n/g, '<br>')}</p>
                <div class="recipe-actions">
                    <a href="${recipe.strYoutube}" target="_blank" class="action-btn primary">Watch Video</a>
                    <a href="${recipe.strSource}" target="_blank" class="action-btn secondary">Read More</a>
                </div>
            `;
            
            const targetElement = document.getElementById(messageId);
            targetElement.innerHTML = `<div class="recipe-result"><div class="recipe-content">${recipeHtml}</div></div>`;
        } catch (error) {
            const targetElement = document.getElementById(messageId);
            targetElement.innerHTML = `<p style="color: var(--red-neon);">❌ Error fetching recipe: ${error.message}</p>`;
        }
    }
    
    async function handleWhiteboardCommand(topic) {
        const messageId = `whiteboard-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;

        const whiteboardHtml = `
            <div class="whiteboard-container" id="whiteboard-${messageId}">
                <div class="whiteboard-header">
                    <h3>📋 Whiteboard: ${topic}</h3>
                    <div class="whiteboard-controls">
                        <button class="action-btn" onclick="showColorPicker('${messageId}')">🎨 Colors</button>
                        <button class="action-btn" onclick="undoBoard('${messageId}')">↶ Undo</button>
                        <button class="action-btn" onclick="clearBoard('${messageId}')">🗑️ Clear</button>
                        <button class="action-btn" onclick="addStickyNote('${messageId}')">📌 Add Note</button>
                    </div>
                </div>
                <div class="whiteboard-canvas-wrapper">
                    <canvas id="canvas-${messageId}" class="whiteboard-canvas"></canvas>
                </div>
            </div>`;
        addMessageToChat('bot', whiteboardHtml);
        
        setTimeout(() => initCanvas(messageId), 100);
    }
    
    function initCanvas(messageId) {
        const canvasEl = document.getElementById(`canvas-${messageId}`);
        if (!canvasEl) return;
        const ctx = canvasEl.getContext('2d');
        const wrapper = canvasEl.parentElement;
        
        const resizeCanvas = () => {
            canvasEl.width = wrapper.clientWidth;
            canvasEl.height = wrapper.clientHeight;
        };
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let paths = [];
        let currentPath = [];

        canvases[messageId] = { ctx, canvasEl, paths, stickyNotes: [], color: '#ffffff' };

        const draw = (e) => {
            if (!isDrawing) return;
            e.preventDefault();
            const rect = canvasEl.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            ctx.strokeStyle = canvases[messageId].color;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            currentPath.push({x, y, color: canvases[messageId].color});
            [lastX, lastY] = [x, y];
        };

        const startDrawing = (e) => {
            isDrawing = true;
            const rect = canvasEl.getBoundingClientRect();
            [lastX, lastY] = [(e.clientX || e.touches[0].clientX) - rect.left, (e.clientY || e.touches[0].clientY) - rect.top];
            currentPath = [{x: lastX, y: lastY, color: canvases[messageId].color}];
        };

        const stopDrawing = () => {
            if (isDrawing) {
                paths.push(currentPath);
                currentPath = [];
                isDrawing = false;
            }
        };

        canvasEl.addEventListener('mousedown', startDrawing);
        canvasEl.addEventListener('mousemove', draw);
        canvasEl.addEventListener('mouseup', stopDrawing);
        canvasEl.addEventListener('mouseout', stopDrawing);
        canvasEl.addEventListener('touchstart', startDrawing);
        canvasEl.addEventListener('touchmove', draw);
        canvasEl.addEventListener('touchend', stopDrawing);
    }
    
    window.undoBoard = (messageId) => {
        const { ctx, canvasEl, paths } = canvases[messageId];
        paths.pop();
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        paths.forEach(path => {
            if (path.length < 2) return;
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            path.forEach(point => {
                ctx.strokeStyle = point.color;
                ctx.lineTo(point.x, point.y);
            });
            ctx.stroke();
        });
    };
    
    window.clearBoard = (messageId) => {
        const { ctx, canvasEl, paths } = canvases[messageId];
        paths.length = 0;
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
    };

    window.showColorPicker = (messageId) => {
        const input = document.createElement('input');
        input.type = 'color';
        input.value = canvases[messageId].color;
        input.addEventListener('input', (e) => setColor(messageId, e.target.value));
        input.click();
    };

    const setColor = (messageId, color) => {
        if (canvases[messageId]) {
            canvases[messageId].color = color;
        }
    };
    
    window.addStickyNote = (messageId) => {
        if (!canvases[messageId]) return;
        const colors = ['#ffeb3b', '#4caf50', '#2196f3', '#ff9800', '#e91e63', '#9c27b0'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        const note = { id: Date.now(), x: 200 + Math.random() * 200, y: 150 + Math.random() * 200, width: 150, height: 100, color: color, text: 'Double-click to edit' };
        canvases[messageId].stickyNotes.push(note);
        renderStickyNote(messageId, note);
    };

    const renderStickyNote = (messageId, note) => {
        const canvasWrapper = document.getElementById(`canvas-${messageId}`).parentElement;
        const noteEl = document.createElement('div');
        noteEl.style.cssText = `position: absolute; left: ${note.x}px; top: ${note.y}px; width: ${note.width}px; height: ${note.height}px; background: ${note.color}; border-radius: 8px; padding: 8px; font-size: 12px; cursor: move; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 50; border: 2px solid rgba(0,0,0,0.1);`;
        noteEl.innerHTML = `<div contenteditable="true" style="width: 100%; height: 100%; outline: none; overflow: hidden; color: #000;">${note.text}</div>`;
        canvasWrapper.appendChild(noteEl);

        let isDragging = false;
        let startX, startY;
        noteEl.addEventListener('mousedown', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true') return;
            e.preventDefault();
            isDragging = true;
            startX = e.clientX - note.x;
            startY = e.clientY - note.y;
            noteEl.style.zIndex = '100';
        });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            note.x = e.clientX - startX;
            note.y = e.clientY - startY;
            noteEl.style.left = note.x + 'px';
            noteEl.style.top = note.y + 'px';
        });
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                noteEl.style.zIndex = '50';
            }
        });
        const textEl = noteEl.querySelector('[contenteditable]');
        textEl.addEventListener('blur', () => {
            note.text = textEl.textContent;
        });
    };

    function handleSupportTicketCommand() {
        // Redirect to the dedicated support page
        window.open('support.html', '_blank');
        addMessageToChat('bot', 'The support ticket form has been opened in a new tab.');
    }

    function loadSupportTickets() {
        // Redirect to the admin panel
        window.open('admin.html', '_blank');
        addMessageToChat('bot', 'The admin panel has been opened in a new tab to view tickets.');
    }

    // --- CHAT LOGIC ---
    const sendMessage = async () => {
        const userInput = chatInput.value.trim();
        if (userInput === '') return;

        addMessageToChat('user', userInput);
        chatInput.value = '';
        commandBuilder.style.display = 'none';
        chatInput.style.display = 'flex';
        currentCommand = null;

        if (userInput.startsWith('/')) {
            const [cmd, ...args] = userInput.substring(1).split(' ');
            const command = commands[cmd];
            if (command) {
                const isAdmin = sessionStorage.getItem('seasworth_is_admin') === 'true';
                if (command.adminOnly && !isAdmin) {
                    addMessageToChat('bot', 'You do not have permission to use this command.');
                    return;
                }
                command.handler(...args);
            } else {
                addMessageToChat('bot', 'Unknown command. Type /help to see all commands.');
            }
        } else {
            addMessageToChat('bot', `<p class="loading-text">Thinking...</p>`, true);
            setTimeout(() => {
                const botResponse = `You said: "${userInput}". I am a demo AI. For specific actions, please use commands like /generate-image or /get-recipe.`;
                updateLastBotMessage(botResponse);
            }, 1500);
        }
    };

    function addMessageToChat(sender, content, isStreaming = false) {
        if (!activeChatId) {
            startNewChat();
        }

        const message = { sender, content, id: `msg-${Date.now()}` };
        const currentChat = chats.find(c => c.id === activeChatId);
        currentChat.messages.push(message);

        const messageBubble = document.createElement('div');
        messageBubble.className = `message-bubble ${sender}-message`;
        messageBubble.id = message.id;
        messageBubble.innerHTML = sender === 'bot' && isStreaming ? content : marked.parse(content);
        
        if (welcomeScreen.style.display !== 'none') {
            chatArea.innerHTML = '';
            welcomeScreen.style.display = 'none';
        }
        
        chatArea.appendChild(messageBubble);
        chatArea.scrollTop = chatArea.scrollHeight;

        saveChats();
    }

    function updateLastBotMessage(content) {
        const currentChat = chats.find(c => c.id === activeChatId);
        if (!currentChat || currentChat.messages.length === 0) return;

        const lastMessage = currentChat.messages[currentChat.messages.length - 1];
        if (lastMessage.sender === 'bot') {
            lastMessage.content = content;
            const lastMessageEl = document.getElementById(lastMessage.id);
            if (lastMessageEl) {
                lastMessageEl.innerHTML = marked.parse(content);
            }
            saveChats();
        }
    }

    // --- UI & CHAT MANAGEMENT ---
    function populateCommands(isAdmin) {
        commandSuggestions.innerHTML = '';
        for (const key in commands) {
            const cmd = commands[key];
            if (cmd.adminOnly && !isAdmin) continue;

            const card = document.createElement('div');
            card.className = 'command-card';
            card.innerHTML = `<div class="cmd-title">/${key}</div><div class="cmd-desc">${cmd.description}</div>`;
            card.onclick = () => {
                if (cmd.params.length > 0) {
                    currentCommand = cmd;
                    chatInput.style.display = 'none';
                    commandBuilder.style.display = 'flex';
                    cmdNameDisplay.textContent = `/${key}`;
                    paramInput.placeholder = cmd.params[0].placeholder;
                    paramInput.focus();
                } else {
                    chatInput.value = `/${key}`;
                    sendMessage();
                }
            };
            commandSuggestions.appendChild(card);
        }
    }

    function startNewChat() {
        const newChat = {
            id: `chat-${Date.now()}`,
            title: 'New Chat',
            messages: []
        };
        chats.unshift(newChat);
        activeChatId = newChat.id;
        saveChats();
        renderChatList();
        renderActiveChat();
    }

    function renderActiveChat() {
        const chat = chats.find(c => c.id === activeChatId);
        chatArea.innerHTML = '';
        if (chat && chat.messages.length > 0) {
            welcomeScreen.style.display = 'none';
            chat.messages.forEach(msg => {
                const messageBubble = document.createElement('div');
                messageBubble.className = `message-bubble ${msg.sender}-message`;
                messageBubble.id = msg.id;
                messageBubble.innerHTML = marked.parse(msg.content);
                chatArea.appendChild(messageBubble);
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        } else {
            welcomeScreen.style.display = 'flex';
            const isAdmin = sessionStorage.getItem('seasworth_is_admin') === 'true';
            populateCommands(isAdmin);
        }
    }

    function renderChatList() {
        chatsList.innerHTML = '<h3>Recent Chats</h3>';
        chats.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.dataset.id = chat.id;
            if (chat.id === activeChatId) {
                chatItem.classList.add('active');
            }
            
            const titleText = chat.messages.length > 0 
                ? chat.messages[0].content.substring(0, 25) + '...'
                : 'New Chat';

            chatItem.innerHTML = `<span class="title">${titleText}</span><button class="delete-chat-btn">×</button>`;
            
            chatItem.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-chat-btn')) return;
                activeChatId = chat.id;
                renderActiveChat();
                renderChatList();
            });

            chatItem.querySelector('.delete-chat-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this chat?')) {
                    deleteChat(chat.id);
                }
            });
            
            chatsList.appendChild(chatItem);
        });
    }

    function deleteChat(chatId) {
        chats = chats.filter(c => c.id !== chatId);
        if (activeChatId === chatId) {
            activeChatId = chats.length > 0 ? chats[0].id : null;
            renderActiveChat();
        }
        saveChats();
        renderChatList();
    }

    // --- LOCAL STORAGE & INITIALIZATION ---
    function saveChats() {
        localStorage.setItem('seasworth_chats', JSON.stringify(chats));
    }

    function loadChats() {
        const savedChats = localStorage.getItem('seasworth_chats');
        if (savedChats) {
            chats = JSON.parse(savedChats);
            if (chats.length > 0) {
                activeChatId = chats[0].id;
            }
        }
    }

    // --- AUTHENTICATION & APP INITIALIZATION ---
    const logout = () => {
        sessionStorage.removeItem('seasworth_logged_in');
        sessionStorage.removeItem('seasworth_user');
        sessionStorage.removeItem('seasworth_is_admin');
        window.location.href = 'login.html';
    };

    const init = () => {
        const isLoggedIn = sessionStorage.getItem('seasworth_logged_in') === 'true';
        if (!isLoggedIn) {
            window.location.href = 'login.html';
            return; 
        }

        const user = sessionStorage.getItem('seasworth_user');
        const isAdmin = sessionStorage.getItem('seasworth_is_admin') === 'true';

        usernameDisplay.textContent = user;
        loadChats();
        renderChatList();
        renderActiveChat();
    };

    // --- EVENT LISTENERS ---
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    paramInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && currentCommand) {
            const paramValue = paramInput.value.trim();
            if (paramValue) {
                chatInput.value = `/${Object.keys(commands).find(k => commands[k] === currentCommand)} ${paramValue}`;
                sendMessage();
                paramInput.value = '';
            }
        }
    });
    newChatBtn.addEventListener('click', startNewChat);
    logoutBtn.addEventListener('click', logout);

    // --- START THE APP ---
    init();
});
</script>
</body>
</html>
