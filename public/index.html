<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>seasworth.ai</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    --bg1: #0b0426;
    --bg2: #16082f;
    --accent1: #7a2bff;
    --accent2: #3a00ff;
    --glass: rgba(255, 255, 255, 0.04);
    --white-glow: rgba(255, 255, 255, 0.15);
    --neon: #b58cff;
    --green-neon: #00ff6a;
    --red-neon: #ff3b3b;
    --font-main: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  * { box-sizing: border-box; font-family: var(--font-main); }
  html, body { height: 100%; margin: 0; background: linear-gradient(180deg, var(--bg1), var(--bg2)); color: #eee; overflow: hidden; }
  a { color: var(--neon); text-decoration: none; }
  .app { display: flex; height: 100vh; width: 100vw; gap: 18px; padding: 28px; align-items: stretch; }
  .sidebar { width: 300px; background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01)); border-radius: 18px; padding: 22px; border: 1px solid rgba(255, 255, 255, 0.03); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45); display: flex; flex-direction: column; gap: 14px; height: calc(100vh - 56px); opacity: 0; transform: translateX(-30px); animation: slideInLeft 0.8s cubic-bezier(.25, .8, .25, 1) forwards; }
  
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand .title { 
    font-size: 22px; 
    font-weight: 900; 
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .brand .robot-icon {
    width: 40px; height: 40px; position: relative;
    display: flex; align-items: center; justify-content: center;
  }
  .brand .robot-icon .robot, .brand .robot-icon .bg-box {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 10px;
  }
  .brand .robot-icon .robot {
    background: linear-gradient(135deg, var(--neon), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; z-index: 2;
    animation: rotate-fast 4s linear infinite;
  }
  .brand .robot-icon .bg-box {
    background: var(--accent1);
    opacity: 0.5;
    z-index: 1;
    animation: rotate-slow 6s linear infinite;
  }
  :root {
  --neon-purple: #7a2bff;
  --outline-purple: #7a2bff;
  }

  .status-orb {
    width: 100%;
    height: 100%;
    position: relative;
  }
  .orb-core {
    position: absolute;
    width: 24px;
    height: 24px;
    background: var(--neon-purple);
    border-radius: 4px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 25px var(--neon-purple), 0 0 50px var(--neon-purple), 0 0 75px var(--neon-purple);
    animation: rotate-core 3s linear infinite reverse;
  }
  @keyframes rotate-core {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to   { transform: translate(-50%, -50%) rotate(360deg); }
  }
  .orb-dot {
    position: absolute;
    width: 10px;
    height: 10px;
    background: var(--neon-purple);
    border-radius: 2px;
    box-shadow: 0 0 12px var(--neon-purple), 0 0 20px var(--outline-purple), 0 0 40px var(--outline-purple);
    top: 50%;
    left: 50%;
    margin: -6px 0 0 -6px;
  }
  .orb-dot:nth-child(2) { animation: orbit-breathe 4s linear infinite 0s; }
  .orb-dot:nth-child(3) { animation: orbit-breathe 4s linear infinite 0.7s; }
  .orb-dot:nth-child(4) { animation: orbit-breathe 4s linear infinite 1.2s; }
  @keyframes orbit-breathe {
    0%   { transform: rotate(0deg) translateX(25px) scale(1) rotate(0deg); }
    25%  { transform: rotate(90deg) translateX(25px) scale(0.7) rotate(-90deg); }
    55%  { transform: rotate(180deg) translateX(25px) scale(1) rotate(-180deg); }
    80%  { transform: rotate(270deg) translateX(25px) scale(0.7) rotate(-270deg); }
    100% { transform: rotate(360deg) translateX(25px) scale(1) rotate(-360deg); }
  }
  .new-chat-btn { width: 100%; padding: 12px; background: var(--accent1); color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .new-chat-btn:hover { background: var(--accent2); box-shadow: 0 0 15px -2px var(--accent1); }
  .chats { flex: 1; overflow-y: auto; padding-right: 8px; margin-top: 10px; }
  .chats h3 { margin: 8px 0 10px 4px; font-size: 15px; color: #ddd; font-weight: 700; }
  .chat-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition: all .18s; position: relative; }
  .chat-item.active, .chat-item:hover { transform: translateX(6px); background: var(--glass); border-color: rgba(255, 255, 255, 0.2); }
  .chat-item .title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
  .main { flex: 1; border-radius: 18px; position: relative; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45); overflow: hidden; opacity: 0; transform: translateY(30px); animation: slideInUp 0.8s 0.2s cubic-bezier(.25, .8, .25, 1) forwards; }
  
  .welcome {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  .welcome-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 20px;
    border-radius: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }
  .welcome h1 {
    font-size: 48px;
    font-weight: 900;
    color: #fff;
    margin: 0 0 10px 0;
    animation: text-glow 3s ease-in-out infinite;
  }
  .welcome p {
    font-size: 18px;
    color: #ccc;
    margin-bottom: 30px;
  }
  .welcome-buttons {
    display: flex;
    gap: 15px;
  }
  .welcome-btn {
    background: #1a1a1a;
    color: white;
    border: none;
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 0 5px rgba(255, 0, 128, 0.5),
                0 0 10px rgba(0, 128, 255, 0.5);
  }
  
  .welcome-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(144, 0, 255, 0.8),
                0 0 20px rgba(0, 128, 255, 0.8),
                0 0 30px rgb(212, 0, 255);
  }
  
  .bg-effects {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }
  
  .floating-dot {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--neon);
    border-radius: 50%;
    opacity: 0.4;
    animation: floatUp 6s linear infinite;
  }
  
  .floating-dot:nth-child(1) { left: 20%; animation-delay: 0s; }
  .floating-dot:nth-child(2) { left: 50%; animation-delay: 2s; }
  .floating-dot:nth-child(3) { left: 80%; animation-delay: 4s; }


  .message-area { flex: 1; width: 100%; padding: 30px; overflow-y: auto; display: none; display: flex; flex-direction: column; gap: 20px; }
  .message-bubble { display: flex; gap: 12px; max-width: 75%; opacity: 0; animation: slideInUp 0.5s forwards; }
  .message-bubble .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
  .message-content { background: rgba(255,255,255,0.05); padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); line-height: 1.6; }
  .message-content p { margin: 0 0 10px 0; }
  .message-content p:last-child { margin-bottom: 0; }
  .message-content ul, .message-content ol { padding-left: 20px; }
  .message-content pre { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; overflow-x: auto; }
  .message-content code { font-family: 'Courier New', Courier, monospace; background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 4px; }
  .message-content pre code { background: none; padding: 0; }
  .message-bubble.user-message { align-self: flex-end; flex-direction: row-reverse; }
  .user-message .icon { background: linear-gradient(135deg, var(--accent1), var(--accent2)); }
  .user-message .message-content { background: var(--accent1); color: white; }
  .bot-message .icon { background: rgba(255,255,255,0.1); }
  .typing-indicator { display: flex; align-items: center; gap: 8px; padding: 14px; }
  .typing-indicator .icon { background: transparent !important; }
  .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background-color: #aaa; animation: typing-bounce 1.4s infinite ease-in-out both; }
  .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
  .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  .composer { padding: 20px 30px; background: rgba(0,0,0,0.1); border-top: 1px solid rgba(255,255,255,0.05); }
  .composer-input-area { display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 999px; border: 1px solid var(--glass); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
  .plus-btn-container { position: relative; }
  .composer .plus-btn { width: 42px; height: 42px; border-radius: 50%; background: transparent; border: none; cursor: pointer; transition: transform 0.3s ease-in-out; position: relative; }
  .composer .plus-btn:not(.command-mode):hover { transform: rotate(90deg); }
  .composer .plus-btn::before,
  .composer .plus-btn::after { content: ''; position: absolute; top: 50%; left: 50%; background-color: #fff; transition: all 0.3s ease-in-out; border-radius: 2px; }
  .composer .plus-btn::before { width: 20px; height: 3px; margin-left: -10px; margin-top: -1.5px; }
  .composer .plus-btn::after { width: 3px; height: 20px; margin-left: -1.5px; margin-top: -10px; }
  .composer .plus-btn.command-mode { transform: rotate(135deg); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
  .composer .plus-btn.command-mode::after { transform: scaleY(0); }
  .composer .plus-btn.command-mode::before { box-shadow: 0 0 6px var(--neon); }
  .attachment-menu { display: none; position: absolute; bottom: 55px; left: 0; background: #1a0a38; border-radius: 12px; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); z-index: 10; }
  .attachment-menu.show { display: block; }
  .attachment-menu-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; cursor: pointer; border-radius: 8px; transition: background 0.2s; }
  .attachment-menu-item:hover { background: var(--accent1); }
  .attachment-menu-item .icon { font-size: 20px; }
  .chat-input-wrapper { display: flex; flex: 1; }
  .composer .chat-input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; padding: 8px 12px; }
  .composer .chat-input:disabled { color: #999; }
  .composer .icon-btn { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(145deg, var(--accent1), var(--accent2)); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; color: white; box-shadow: 0 0 15px -2px var(--accent1); animation: glow-pulse 2.5s ease-in-out infinite; transition: background 0.4s ease, box-shadow 0.4s ease; }
  .composer .icon-btn svg { width: 22px; height: 22px; }
  .composer .send-btn { background: linear-gradient(145deg, var(--accent1), var(--accent2)); }
  .app.offline .send-btn, .composer .send-btn:disabled { background: #555; cursor: not-allowed; animation: none; box-shadow: none; opacity: 0.5; }
  #image-preview-container { display: flex; gap: 10px; flex-wrap: wrap; padding: 0 10px; margin-bottom: 10px; }
  .image-preview-item { position: relative; }
  .image-preview-item img { max-width: 80px; max-height: 80px; border-radius: 8px; border: 2px solid var(--accent1); }
  .image-preview-item .remove-img-btn { position: absolute; top: -5px; right: -5px; background: var(--red-neon); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 20px; text-align: center; }
  .status-indicator { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 12px; background: rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.02); }
  .status-dot { width: 10px; height: 10px; border-radius: 50%; transition: all 0.4s ease; }
  .status-text { font-weight: 600; font-size: 14px; transition: color 0.4s ease; }
  .app:not(.offline) .status-dot { background-color: var(--green-neon); box-shadow: 0 0 10px var(--green-neon), 0 0 20px rgba(0, 255, 106, 0.5); }
  .app:not(.offline) .status-text { color: #fff; }
  .app:not(.offline) #status-toggle-btn { background: linear-gradient(145deg, var(--red-neon), #c50000); animation: glow-pulse-red 2.5s ease-in-out infinite; }
  .app:not(.offline) #status-toggle-btn .icon-play { display: none; }
  .app:not(.offline) #status-toggle-btn .icon-stop { display: block; }
  .app.offline .status-indicator .status-dot { background-color: var(--red-neon); box-shadow: 0 0 10px var(--red-neon), 0 0 20px rgba(255, 59, 59, 0.5); }
  .app.offline .status-indicator .status-text { color: var(--red-neon); }
  .app.offline #status-toggle-btn { background: linear-gradient(145deg, var(--green-neon), #00a846); animation: glow-pulse-green 2.5s ease-in-out infinite; }
  .app.offline #status-toggle-btn .icon-play { display: block; }
  .app.offline #status-toggle-btn .icon-stop { display: none; }
  .chats::-webkit-scrollbar, .message-area::-webkit-scrollbar { width: 6px; }
  .chats::-webkit-scrollbar-thumb, .message-area::-webkit-scrollbar-thumb { background: var(--accent1); border-radius: 999px; }
  .chats::-webkit-scrollbar-track, .message-area::-webkit-scrollbar-track { background: transparent; }
  .muted { color: #cfc8ff8a; font-size: 13px; }
  @keyframes rotate-orb { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes pulse-core { 0%, 100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 8px var(--green-neon); } 50% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 14px var(--green-neon); } }
  @keyframes rotate-fast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
  @keyframes slideInLeft { to { opacity: 1; transform: none; } }
  @keyframes slideInUp { to { opacity: 1; transform: none; } }
  @keyframes text-glow { 0%, 100% { text-shadow: 0 0 10px rgba(181, 140, 255, 0.3), 0 0 20px rgba(181, 140, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(181, 140, 255, 0.5), 0 0 40px rgba(181, 140, 255, 0.4); } }
  @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 15px -2px var(--accent1); } 50% { box-shadow: 0 0 25px 0px var(--accent1); } }
  @keyframes glow-pulse-green { 0%, 100% { box-shadow: 0 0 15px -2px var(--green-neon); } 50% { box-shadow: 0 0 25px 0px var(--green-neon); } }
  @keyframes glow-pulse-red { 0%, 100% { box-shadow: 0 0 15px -2px var(--red-neon); } 50% { box-shadow: 0 0 25px 0px var(--red-neon); } }
  @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
  
  @keyframes text-glow { 0%, 100% { text-shadow: 0 0 10px rgba(181, 140, 255, 0.3), 0 0 20px rgba(181, 140, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(181, 140, 255, 0.5), 0 0 40px rgba(181, 140, 255, 0.4); } }
  
  @keyframes floatUp {
    0% {
      transform: translateY(100vh);
      opacity: 0;
    }
    10% {
      opacity: 0.4;
    }
    90% {
      opacity: 0.4;
    }
    100% {
      transform: translateY(-50px);
      opacity: 0;
    }
  }
  @media (max-width: 900px) { 
    .app { padding: 10px; flex-direction: column; } 
    .sidebar { display: none; } 
    .welcome h1 { font-size: 36px; } 
    .welcome-buttons { flex-direction: column; } 
    .composer { padding: 10px; } 
    .composer-input-area { width: 100%; } 
  }
</style>
<style>
    .composer { position: relative; }
    #command-selector { display: none; position: absolute; bottom: 95px; left: 30px; width: calc(100% - 60px); max-height: 300px; overflow-y: auto; background: rgba(15, 25, 45, 0.95); border: 1px solid rgba(64, 128, 255, 0.4); border-radius: 16px; box-shadow: 0 -10px 40px rgba(0,0,0,0.6), 0 0 20px rgba(15, 25, 45, 0.8); padding: 12px; z-index: 9999; backdrop-filter: blur(15px); }
    .command-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
    .command-item:hover { background: rgba(122,43,255,0.2); border-color: rgba(122,43,255,0.5); transform: translateX(4px); box-shadow: 0 4px 15px rgba(122,43,255,0.2); }
    .command-icon { width: 36px; height: 36px; font-size: 20px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--accent1), var(--accent2)); border-radius: 8px; box-shadow: 0 4px 12px rgba(122,43,255,0.3); }
    .command-name { font-weight: 700; color: #fff; font-size: 15px; }
    .command-desc { font-size: 13px; color: #ccc; margin-top: 2px; }
    .message-content img.generated-image { max-width: 400px; max-height: 400px; border-radius: 8px; margin-top: 10px; cursor: pointer; transition: transform 0.2s ease-in-out; }
    .message-content img.generated-image:hover { transform: scale(1.03); }
    .action-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .action-buttons button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 6px 12px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
    .action-buttons button:hover { background: var(--accent1); }
    
    /* Recipe Styles */
    .recipe-container { background: rgba(0,0,0,0.2); border-radius: 16px; padding: 20px; border: 1px solid rgba(122,43,255,0.3); }
    .recipe-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .diet-selector { display: flex; gap: 6px; flex-wrap: wrap; }
    .diet-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 600; }
    .diet-btn.active, .diet-btn:hover { background: var(--accent1); border-color: var(--neon); color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(122,43,255,0.3); }
    .recipe-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .option-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(122,43,255,0.3); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
    .option-card:hover { background: rgba(122,43,255,0.15); border-color: var(--neon); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(122,43,255,0.4); }
    .option-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s; }
    .option-card:hover::before { left: 100%; }
    .option-icon { font-size: 2.2em; margin-bottom: 8px; }
    .option-card h4 { color: var(--neon); margin: 8px 0 4px 0; font-size: 14px; }
    .option-card p { color: #ccc; font-size: 12px; margin: 0; line-height: 1.3; }
    .ingredient-panel { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 20px; margin-top: 15px; border: 1px solid rgba(122,43,255,0.2); }
    .quick-ingredients { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .quick-ingredient-btn { background: rgba(122,43,255,0.2); border: 1px solid rgba(122,43,255,0.4); color: white; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .quick-ingredient-btn:hover { background: var(--accent1); transform: scale(1.05); }
    .ingredient-input-container { display: flex; gap: 8px; margin-bottom: 10px; }
    .ingredient-input-container input { flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid var(--accent1); border-radius: 8px; color: white; font-size: 14px; }
    .ingredient-input-container input::placeholder { color: #888; }
    .add-btn { background: var(--accent1); color: white; border: none; padding: 12px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
    .add-btn:hover { background: var(--accent2); transform: translateY(-1px); }
    .suggestions { max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
    .suggestion-item { background: rgba(255,255,255,0.1); padding: 8px 12px; margin: 2px 0; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
    .suggestion-item:hover { background: var(--accent1); }
    .selected-ingredients { margin: 15px 0; }
    .ingredient-tag { display: inline-block; background: var(--accent1); color: white; padding: 6px 12px; border-radius: 15px; margin: 3px; font-size: 12px; box-shadow: 0 2px 8px rgba(122,43,255,0.3); }
    .ingredient-tag button { background: none; border: none; color: white; margin-left: 8px; cursor: pointer; font-weight: bold; width: 16px; height: 16px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
    .ingredient-tag button:hover { background: rgba(255,255,255,0.2); }
    .panel-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .action-btn.primary { background: var(--green-neon); color: #000; }
    .action-btn.primary:hover, .action-btn.primary:active { background: #681fff; color: #fff; box-shadow: 0 0 15px #681fff; }
    .action-btn.secondary { background: rgba(255,255,255,0.1); color: #ccc; }
    .recipe-result { margin-top: 20px; }
    .recipe-content { background: #4a1a8a; border-radius: 12px; padding: 20px; color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .recipe-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .loading-text { font-size: 18px; font-weight: 600; color: var(--neon); animation: textPulse 2s ease-in-out infinite; }
    .delete-chat-btn { display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: white; font-size: 22px; font-weight: bold; cursor: pointer; padding: 0 5px; opacity: 0.7; transition: opacity 0.2s; }
    .chat-item:hover .delete-chat-btn { display: block; }
    .delete-chat-btn:hover { opacity: 1; text-shadow: 0 0 8px var(--red-neon); }
    .image-loader-container { padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; text-align: center; }
    .image-loader-animation { position: relative; width: 300px; height: 300px; margin: 15px auto 0; border-radius: 12px; background: rgba(0,0,0,0.3); overflow: hidden; }
    .image-loader-box { position: absolute; width: 100px; height: 100px; background: var(--neon); box-shadow: 0 0 35px var(--neon); animation: moveBox 12s cubic-bezier(0.65, 0, 0.35, 1) infinite; }
    @keyframes moveBox { 0%   { top: 0; left: 0; border-radius: 50%; } 25%  { top: calc(100% - 100px); left: calc(100% - 100px); border-radius: 0; } 50%  { top: calc(100% - 100px); left: 0; border-radius: 50%; } 75%  { top: 0; left: calc(100% - 100px); border-radius: 0; } 100% { top: 0; left: 0; border-radius: 50%; } }
     .command-builder { display: none; align-items: center; flex: 1; gap: 10px; }
    .command-builder .cmd-name { font-size: 16px; font-weight: 600; color: #fff; }
    .command-builder .param-input-box { display: flex; align-items: center; border: 1px solid #4f4f52; background: #2b2d31; border-radius: 6px; padding: 4px 8px; flex: 1; }
    .command-builder .param-input { background: transparent; border: none; outline: none; color: #fff; font-size: 16px; width: 100%; }
    .crypto-container .price-up, .crypto-list-item .price-up, .crypto-rec-card .price-up { color: var(--green-neon); }
    .crypto-container .price-down, .crypto-list-item .price-down, .crypto-rec-card .price-down { color: var(--red-neon); }
    .crypto-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
    .crypto-header h3 { margin: 0; }
    #crypto-refresh-btn { background: var(--accent1); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    #crypto-refresh-btn.active { background: var(--green-neon); color: #000; }
    .crypto-recommendations { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .crypto-rec-card { background: rgba(255, 255, 255, 0.07); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid transparent; transition: all 0.2s ease-in-out; }
    .crypto-rec-card:hover { transform: translateY(-5px); border-color: var(--accent1); }
    .crypto-rec-card .crypto-icon { margin: 0 auto 10px auto; }
    .crypto-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
    .crypto-list::-webkit-scrollbar { width: 4px; }
    .crypto-list::-webkit-scrollbar-thumb { background: var(--accent1); border-radius: 999px; }
    .crypto-list-item { display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; }
    .crypto-icon { width: 32px; height: 32px; margin-right: 12px; }
    .crypto-info { flex-grow: 1; }
    .crypto-name { font-weight: 600; }
    .crypto-symbol { color: #aaa; font-size: 14px; }
    .crypto-price-details { text-align: right; }
    .crypto-price { font-weight: 600; font-size: 16px; }
    .crypto-change { font-size: 14px; }
    .crypto-divider { height: 1px; background: linear-gradient(90deg, transparent, var(--accent1), transparent); margin: 20px 0; border: 0; }
    
    /* Study & Quiz Styles */
    .study-guide-container h3 { color: var(--neon); border-bottom: 1px solid var(--neon); padding-bottom: 5px; }
    #quiz-container, #quiz-setup-panel { margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px;}
    .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .quiz-question { font-size: 1.1em; font-weight: 600; margin-bottom: 15px; }
    .quiz-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .quiz-option { background: rgba(255,255,255,0.1); border: 1px solid transparent; color: #fff; padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; }
    .quiz-option:hover { border-color: var(--accent1); }
    .quiz-option.correct { background: var(--green-neon) !important; color: #000 !important; border-color: var(--green-neon) !important; transform: scale(1.02); }
    .quiz-option.wrong { background: var(--red-neon) !important; color: #fff !important; border-color: var(--red-neon) !important; }
    .quiz-option:disabled { cursor: not-allowed; opacity: 0.7; }
    .quiz-results { text-align: center; }
    .quiz-progress { display: flex; align-items: center; gap: 15px; }
    .progress-bar { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent1), var(--neon)); transition: width 0.3s ease; }
    .quiz-option { transition: all 0.3s ease; }
    .quiz-option.correct { animation: correctPulse 0.6s ease; }
    .quiz-option.wrong { animation: wrongShake 0.6s ease; }
    @keyframes correctPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes wrongShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .quiz-visual-progress {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
        gap: 5px;
    }
    .progress-step {
        display: flex;
        align-items: center;
    }
    .progress-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        transition: all 0.3s ease;
    }
    .progress-circle.correct {
        background: var(--green-neon);
        border-color: var(--green-neon);
        color: #000;
        box-shadow: 0 0 15px var(--green-neon);
    }
    .progress-circle.wrong {
        background: var(--red-neon);
        border-color: var(--red-neon);
        color: #fff;
        box-shadow: 0 0 15px var(--red-neon);
    }
    .progress-line {
        width: 30px;
        height: 3px;
        background: rgba(255,255,255,0.2);
        margin: 0 5px;
    }
    .quiz-setup-panel {
        padding: 35px !important;
        border-radius: 20px !important;
        box-shadow: 0 15px 40px rgba(122,43,255,0.25) !important;
        backdrop-filter: blur(15px) !important;
        min-height: 450px !important;
        width: 100% !important;
        max-width: 750px !important;
        margin: 0 auto !important;
    }
    .footer-tabs {
        display: flex;
        gap: 3px;
        margin-top: auto;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .footer-tab {
        padding: 4px 6px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: #ccc;
        border-radius: 6px;
        cursor: pointer;
        font-size: 9px;
        font-weight: 500;
        transition: all 0.2s;
        text-align: center;
        min-width: 50px;
        white-space: nowrap;
    }
    .footer-tab:hover {
        background: rgba(122,43,255,0.2);
        border-color: var(--neon);
        color: var(--neon);
        transform: translateY(-1px);
        box-shadow: 0 0 5px var(--neon);
    }
    .footer-tab.active {
        background: var(--neon) !important;
        border-color: var(--neon) !important;
        color: #000 !important;
        box-shadow: 0 0 15px var(--neon);
        font-weight: 600;
    }
    .quiz-setup-section { margin-bottom: 15px; }
    .quiz-setup-section label { display: block; margin-bottom: 8px; font-weight: 600; }
    .difficulty-btns button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 8px 12px; color: #fff; border-radius: 6px; cursor: pointer; margin-right: 5px; }
    .difficulty-btns button.selected { background: var(--accent1); border-color: var(--accent1); }
    .slider-container { display: flex; align-items: center; gap: 15px; }
    input[type=range] { 
        flex-grow: 1; 
        -webkit-appearance: none;
        height: 6px;
        border-radius: 3px;
        background: rgba(255,255,255,0.1);
        outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        border: 3px solid var(--neon);
        box-shadow: 0 0 10px var(--neon);
    }
    input[type=range]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        border: 3px solid var(--neon);
        box-shadow: 0 0 10px var(--neon);
    }
    input[type=range]::-webkit-slider-track {
        background: var(--neon);
        height: 6px;
        border-radius: 3px;
    }
    #start-quiz-btn { width: 100%; padding: 12px; background: var(--green-neon); color: #000; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
    .footer-tabs {
        display: flex;
        gap: 3px;
        margin-top: auto;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .footer-tab {
        padding: 4px 6px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: #ccc;
        border-radius: 6px;
        cursor: pointer;
        font-size: 9px;
        font-weight: 500;
        transition: all 0.2s;
        text-align: center;
        min-width: 50px;
        white-space: nowrap;
    }
    .footer-tab:hover {
        background: rgba(122,43,255,0.2);
        border-color: var(--neon);
        color: var(--neon);
        transform: translateY(-1px);
        box-shadow: 0 0 5px var(--neon);
    }
    .footer-tab.active {
        background: var(--neon) !important;
        border-color: var(--neon) !important;
        color: #000 !important;
        box-shadow: 0 0 15px var(--neon);
        font-weight: 600;
    }
    .image-loading-container {
        text-align: center;
        padding: 40px 20px;
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        border: 1px solid rgba(122,43,255,0.3);
    }
    .loading-text {
        font-size: 18px;
        font-weight: 600;
        color: var(--neon);
        margin-bottom: 30px;
        animation: textPulse 2s ease-in-out infinite;
    }
    .neon-cubes-container {
        position: relative;
        width: 300px;
        height: 200px;
        margin: 0 auto;
        perspective: 1000px;
    }
    .neon-cube {
        position: absolute;
        width: 30px;
        height: 30px;
        background: linear-gradient(45deg, var(--neon), var(--accent1));
        border-radius: 4px;
        box-shadow: 0 0 20px var(--neon), 0 0 40px rgba(122,43,255,0.5);
        animation: cubeFloat 4s ease-in-out infinite;
    }
    .cube-1 { top: 20px; left: 50px; animation-delay: 0s; }
    .cube-2 { top: 80px; left: 20px; animation-delay: 0.5s; }
    .cube-3 { top: 140px; left: 80px; animation-delay: 1s; }
    .cube-4 { top: 30px; right: 40px; animation-delay: 1.5s; }
    .cube-5 { top: 100px; right: 70px; animation-delay: 2s; }
    .cube-6 { top: 160px; right: 20px; animation-delay: 2.5s; }
    @keyframes cubeFloat {
        0% { transform: translateY(0px) rotateX(0deg) rotateY(0deg) scale(1); opacity: 0.7; }
        25% { transform: translateY(-20px) rotateX(90deg) rotateY(45deg) scale(1.1); opacity: 1; }
        50% { transform: translateY(-10px) rotateX(180deg) rotateY(90deg) scale(0.9); opacity: 0.8; }
        75% { transform: translateY(-30px) rotateX(270deg) rotateY(135deg) scale(1.2); opacity: 1; left: 50%; top: 50%; margin-left: -15px; margin-top: -15px; }
        100% { transform: translateY(-50px) rotateX(360deg) rotateY(180deg) scale(0.5); opacity: 0; left: 50%; top: 30%; margin-left: -15px; margin-top: -15px; }
    }
    @keyframes textPulse {
        0%, 100% { opacity: 0.7; text-shadow: 0 0 10px var(--neon); }
        50% { opacity: 1; text-shadow: 0 0 20px var(--neon), 0 0 30px var(--neon); }
    }
    .recipe-content table { width: 100%; border-collapse: collapse; margin: 15px 0; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden; border: 1px solid rgba(122,43,255,0.4); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .recipe-content th, .recipe-content td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.15); color: #fff; }
    .recipe-content th { background: linear-gradient(135deg, #7a2bff, #5a1fb8); color: white; font-weight: 700; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
    .recipe-content td { background: rgba(0,0,0,0.3); font-weight: 500; }
    .recipe-content tr:hover td { background: rgba(122,43,255,0.25); transform: scale(1.01); transition: all 0.2s; }
    .recipe-content h1, .recipe-content h2 { color: #fff; margin-bottom: 15px; font-size: 28px; text-shadow: 0 0 10px rgba(122,43,255,0.5); }
    .recipe-content h3, .recipe-content h4 { color: var(--neon); margin-top: 25px; margin-bottom: 12px; font-size: 18px; }
    .recipe-content p { color: #e0e0e0; line-height: 1.7; margin-bottom: 15px; }
    .recipe-content ol, .recipe-content ul { padding-left: 25px; color: #e0e0e0; }
    .recipe-content li { margin-bottom: 10px; line-height: 1.6; }
    .recipe-content strong { color: var(--neon); font-weight: 700; }
    .recipe-content em { color: #ccc; font-style: italic; }
    .nutrition-table { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 20px 0; }
    .nutrition-item { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(122,43,255,0.3); }
    .nutrition-value { font-size: 24px; font-weight: 700; color: var(--neon); }
    .nutrition-label { font-size: 12px; color: #ccc; text-transform: uppercase; margin-top: 5px; }
    .recipe-meta { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
    .meta-item { background: rgba(0,0,0,0.4); padding: 12px 20px; border-radius: 20px; border: 1px solid rgba(122,43,255,0.3); }
    .meta-label { font-size: 11px; color: #ccc; text-transform: uppercase; }
    .meta-value { font-size: 16px; font-weight: 600; color: #fff; }
    .schedule-container {
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid rgba(122,43,255,0.3);
    }
    .schedule-container h3 {
        color: var(--neon);
        margin-bottom: 15px;
        text-align: center;
    }
    .schedule-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        overflow: hidden;
    }
    .schedule-content th, .schedule-content td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .schedule-content th {
        background: var(--accent1);
        color: white;
        font-weight: 600;
    }
    .schedule-content tr:hover {
        background: rgba(122,43,255,0.1);
    }
    .schedule-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    .action-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(122,43,255,0.3);
        color: #fff;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .action-btn:hover {
        background: var(--accent1);
        border-color: var(--neon);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(122,43,255,0.3);
    }
    
    .whiteboard-container {
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid rgba(122,43,255,0.3);
        margin: 10px 0;
    }
    
    .whiteboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .whiteboard-header h3 {
        color: var(--neon);
        margin: 0;
        flex: 1;
        min-width: 200px;
    }
    
    .whiteboard-controls {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .whiteboard-controls .action-btn {
        padding: 6px 12px;
        font-size: 12px;
        white-space: nowrap;
    }
    
    .whiteboard-selection {
        padding: 20px;
        background: rgba(0,0,0,0.1);
        border-radius: 12px;
        margin-bottom: 15px;
    }
    
    .selection-panel h4, .topic-panel h4 {
        color: var(--neon);
        margin-bottom: 15px;
        text-align: center;
    }
    
    .selection-options {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .selection-btn {
        background: linear-gradient(45deg, var(--accent1), var(--accent2));
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(122,43,255,0.3);
    }
    
    .selection-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(122,43,255,0.5);
    }
    
    .whiteboard-canvas {
        position: relative;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid rgba(122,43,255,0.3);
        padding: 20px;
        min-height: 600px;
    }
    
    .drawing-toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        padding: 10px;
        background: rgba(0,0,0,0.1);
        border-radius: 8px;
        flex-wrap: wrap;
    }
    
    .tool-btn {
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid rgba(122,43,255,0.3);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
    }
    
    .tool-btn.active, .tool-btn:hover {
        background: var(--accent1);
        border-color: var(--neon);
        transform: translateY(-1px);
    }
    
    .tool-btn.ai-help {
        background: linear-gradient(45deg, var(--green-neon), #00a846);
        border-color: var(--green-neon);
    }
    
    .whiteboard-elements {
        position: absolute;
        top: 80px;
        left: 20px;
        width: calc(100% - 40px);
        height: calc(100% - 100px);
        pointer-events: none;
    }
    .video-quality-panel {
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid rgba(122,43,255,0.3);
        text-align: center;
    }
    .quality-options {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 15px;
    }
    .quality-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(122,43,255,0.3);
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    .quality-btn:hover {
        background: var(--accent1);
        transform: translateY(-2px);
    }
    .quality-recommended {
        background: var(--green-neon) !important;
        color: #000 !important;
        border-color: var(--green-neon) !important;
    }
    .video-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    .video-actions .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .video-actions .action-btn:hover {
        transform: translateY(-1px);
    }
    
    .wb-element {
        position: absolute;
        background: #7a2bff;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: move;
        pointer-events: all;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(122,43,255,0.4);
        min-width: 100px;
        text-align: center;
    }
    
    .wb-element:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 18px rgba(122,43,255,0.6);
    }

</style>
</head>
<body>

    <div class="app" id="app">
    <aside class="sidebar" role="navigation">
        <div class="brand">
        <div class="robot-icon" aria-hidden="true">
            <div class="bg-box"></div>
            <div class="robot"></div>
        </div>
        <div>
            <div class="title">
            <span>seasworth.ai</span>
            </div>
            <div class="muted">private ‚Ä¢ online</div>
        </div>
        </div>
        <div class="status-indicator">
        <div class="status-dot"></div>
        <div class="status-text">Online</div>
        </div>
        <button class="new-chat-btn">‚äï New Chat</button>
        <div class="chats">
        <h3>Chats</h3>
        </div>
        <div class="footer-tabs" id="footer-tabs">
            <button class="footer-tab" onclick="showAbout()">‚ÑπÔ∏è About</button>
            <button class="footer-tab" onclick="showHelp()">‚ùì Help</button>
            <button class="footer-tab" id="dev-portal-tab" onclick="showDevPortal()">‚öôÔ∏è Dev Portal</button>
            <button class="footer-tab" onclick="logout()">üö™ Log Out</button>
        </div>
    </aside>
    <main class="main">
        <div class="welcome">
            <img src="https://i.ibb.co/WWb0TZwK/seasworth-ai-logo.jpg" 
                 alt="Seasworth AI Logo" 
                 class="welcome-logo" 
                 style="width: 200px; height: auto; display: block; margin: 0 auto 10px auto;">
                 
           <h1 style="font-size: 3rem; text-align: center;">
          Welcome to seasworth<span style="color: rgba(0,128,255,0.8);">.ai</span>
        </h1>
        
            
            <p style="text-align: center; font-size: 1.2rem;">
                Your cool, personalized and super helpful AI buddy who saves you at any moment
            </p>
            
        <div class="welcome-buttons" style="text-align: center; display: flex; justify-content: center; flex-wrap: wrap; gap: 12px;">
            <button class="welcome-btn" onclick="quickStart('/image ')">üé® Create an Image</button>
            <button class="welcome-btn" onclick="quickStart('/video ')">üé¨ Generate Video</button>
            <button class="welcome-btn" onclick="quickStart('/crypto')">üí∞ Check Crypto</button>
            <button class="welcome-btn" onclick="quickStart('/study')">üìö Study with seasworth</button>
            <button class="welcome-btn" onclick="quickStart('/research')">üåê Research on a Topic</button>
            <button class="welcome-btn" onclick="quickStart('/quiz')">üß† Quiz Yourself!</button>
            <button class="welcome-btn" onclick="quickStart('/whiteboard')">üìã Whiteboard</button>
        </div>
        
        <div class="bg-effects">
            <div class="floating-dot"></div>
            <div class="floating-dot"></div>
            <div class="floating-dot"></div>
        </div>
        </div>

        <div class="message-area"></div>
        <div class="composer">
            <div id="reply-bar" style="display: none; background: rgba(122,43,255,0.1); border: 1px solid rgba(122,43,255,0.3); border-radius: 8px; padding: 8px 12px; margin-bottom: 10px; font-size: 14px; color: var(--neon); display: flex; justify-content: space-between; align-items: center;">
                <span id="reply-text">‚Ü©Ô∏è Replying to this message</span>
                <button onclick="cancelReply()" style="background: none; border: none; color: var(--neon); cursor: pointer; font-size: 16px; padding: 0 4px;">√ó</button>
            </div>
            <div id="command-selector"></div>
            <div id="image-preview-container"></div>
            <div class="composer-input-area">
                <div class="plus-btn-container">
                    <button class="plus-btn" id="attach-btn" title="Attachments / Commands"></button>
                    <div class="attachment-menu" id="attachment-menu">
                        <div class="attachment-menu-item" id="attach-photo"> <span class="icon">üñºÔ∏è</span> <span>Photo</span> </div>
                        <div class="attachment-menu-item" id="attach-file"> <span class="icon">üìÅ</span> <span>File</span> </div>
                        <div class="attachment-menu-item" id="attach-video"> <span class="icon">üìπ</span> <span>Video</span> </div>
                    </div>
                </div>
                <input type="file" id="file-upload-input" style="display: none;" multiple accept="image/*">
                
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Start a new conversation...">
                </div>

                <div class="command-builder" id="command-builder">
                    </div>

                <button class="icon-btn" title="Use microphone"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm-1 7v-3.075q-2.6-.35-4.3-2.325T4 11H6q0 2.075 1.463 3.538T11 16v-1H8v-2h8v2h-3v1q2.075 0 3.538-1.463T18 11h2q0 2.225-1.7 4.2T13 18.075V21h-2Z"/></svg></button>
                <button class="icon-btn" id="status-toggle-btn" title="Toggle AI Status"><svg class="icon-play" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor" style="display: none;"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M8 5v14l11-7L8 5z"/></svg><svg class="icon-stop" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 6h12v12H6V6z"/></svg></button>
                <button class="icon-btn send-btn" title="Send Message"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3.4 20.4l17.45-7.48c.81-.35.81-1.49 0-1.84L3.4 3.6c-.66-.29-1.39.2-1.39.91L2 9.12c0 .5.37.93.87.99L17 12 2.87 13.88c-.5.07-.87.5-.87 1l-.01 4.61c0 .71.73 1.2 1.39.91z"/></svg></button>
            </div>
        </div>
    </main>
    </div>

<div id="image-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center;">
  <span id="modal-close" style="position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;">&times;</span>
  <img id="modal-image" style="margin: auto; display: block; max-width: 90%; max-height: 90%;">
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SELECTORS ---
    const appContainer = document.getElementById('app');
    const statusToggleButton = document.getElementById('status-toggle-btn');
    const statusTextElement = document.querySelector('.status-indicator .status-text');
    const chatInputWrapper = document.querySelector('.chat-input-wrapper');
    const chatInputElement = document.getElementById('chat-input');
    const commandBuilder = document.getElementById('command-builder');
    const newChatBtn = document.querySelector('.new-chat-btn');
    const chatsContainer = document.querySelector('.chats');
    const welcomeScreen = document.querySelector('.welcome');
    const messageArea = document.querySelector('.message-area');
    const sendBtn = document.querySelector('.send-btn');
    const attachBtn = document.getElementById('attach-btn');
    const attachmentMenu = document.getElementById('attachment-menu');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const attachPhotoBtn = document.getElementById('attach-photo');
    const attachFileBtn = document.getElementById('attach-file');
    const attachVideoBtn = document.getElementById('attach-video');
    const fileUploadInput = document.getElementById('file-upload-input');
    const commandSelector = document.getElementById('command-selector');
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const modalClose = document.getElementById('modal-close');

    // --- COMMANDS DEFINITION ---
    const commands = [
        { name: '/image', icon: 'üñºÔ∏è', description: 'Generate an image from a text prompt.', params: [{name: 'prompt'}] },
        { name: '/video', icon: 'üé¨', description: 'Generate a video from a text prompt.', params: [{name: 'prompt'}] },
        { name: '/research', icon: 'üåê', description: 'Search the web for an answer.', params: [{name: 'query'}]},
        { name: '/crypto', icon: 'üí∞', description: 'Get crypto prices & recommendations.' },
        { name: '/design', icon: 'üé®', description: 'Create a design with Canva AI.' },
        { name: '/study', icon: 'üìö', description: 'Get a study guide on any topic.', params: [{name: 'topic'}] },
        { name: '/quiz', icon: 'üß†', description: 'Start a custom quiz on any topic.', params: [{name: 'topic'}] },
        { name: '/schedule', icon: 'üìÖ', description: 'Create a schedule or routine table.', params: [{name: 'prompt'}] },
        { name: '/whiteboard', icon: 'üìã', description: 'Create an interactive whiteboard.', params: [{name: 'topic'}] },
        { name: '/recipe', icon: 'üç≥', description: 'Get recipes based on ingredients or generate new ones.' },
        { name: '/help', icon: '‚ùì', description: 'Show help information.' },
        { name: '/clear', icon: 'üßπ', description: 'Clears the current chat history.' }
    ];

    // --- STATE ---
    let chats = [];
    let activeChatId = null;
    let isOffline = false;
    let attachedImages = [];
    let abortController = null;
    let commandMode = null;
    let cryptoRefreshInterval = null;
    let lastCryptoPrices = {};
    let currentQuizState = {};

    // --- CORE FUNCTIONS ---
    const saveChats = () => {
        try {
            const chatsToSave = JSON.parse(JSON.stringify(chats));
            localStorage.setItem('seasworth_chats_v4', JSON.stringify(chatsToSave));
        } catch (e) {
            console.error("Error saving chats:", e);
        }
    };
    
    const loadChats = () => {
        const saved = localStorage.getItem('seasworth_chats_v4');
        if (saved) {
            try {
                chats = JSON.parse(saved);
            } catch (e) {
                chats = [];
            }
        }
    };
    
    const renderChatList = () => {
        chatsContainer.innerHTML = '<h3>Chats</h3>';
        if (chats.length === 0) return;
        [...chats].reverse().forEach(chat => {
            const el = document.createElement('div');
            el.className = 'chat-item';
            el.dataset.id = chat.id;
            const title = document.createElement('div');
            title.className = 'title';
            title.textContent = chat.title;
            el.appendChild(title);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-chat-btn';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.title = 'Delete Chat';
            el.appendChild(deleteBtn);
            deleteBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                stopCryptoRefresh();
                const chatIndex = chats.findIndex(c => c.id === chat.id);
                if (chatIndex > -1) {
                    chats.splice(chatIndex, 1);
                }
                if (activeChatId === chat.id) {
                    activeChatId = null;
                    showWelcomeScreen();
                }
                renderChatList();
                saveChats();
            });
            if (chat.id === activeChatId && activeChatId !== 'about' && activeChatId !== 'help') el.classList.add('active');
            el.addEventListener('click', () => selectChat(chat.id));
            chatsContainer.appendChild(el);
        });
    };
    
    const renderChatContent = () => {
        const chat = chats.find(c => c.id === activeChatId);
        if (!chat) { showWelcomeScreen(); return; }
        welcomeScreen.style.display = 'none';
        messageArea.style.display = 'flex';
        messageArea.innerHTML = '';
        chat.messages.forEach(msg => {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${msg.role}-message`;
            if (msg.id) bubble.id = msg.id;
            const icon = document.createElement('div');
            icon.className = 'icon';
            if (msg.role === 'bot') {
                icon.innerHTML = `<div class="status-orb" title="Seasworth"><div class="orb-core"></div><div class="orb-dot"></div><div class="orb-dot"></div><div class="orb-dot"></div></div>`;
            } else {
                icon.textContent = 'U';
            }
            const content = document.createElement('div');
            content.className = 'message-content';
            if (msg.isImageLoading) {
                 content.innerHTML = `<div class="image-loader-container">...</div>`;
            } else {
                let messageContent = '';
                if (msg.role === 'user' && msg.replyTo) {
                    messageContent = `<div style="font-size: 12px; color: var(--neon); margin-bottom: 8px; opacity: 0.8;">‚Ü©Ô∏è Replying to ${msg.replyTo}</div>`;
                }
                
                if (msg.text && (msg.text.includes('crypto-list') || msg.text.includes('design-menu') || msg.text.includes('study-guide-container') || msg.text.includes('quiz-setup-panel') || msg.text.includes('whiteboard-container') || msg.text.includes('recipe-container'))) {
                    messageContent += msg.text;
                } else {
                    messageContent += marked.parse(msg.text || '');
                }
                content.innerHTML = messageContent;
                if (msg.images && msg.images.length > 0) {
                    const imageGrid = document.createElement('div');
                    imageGrid.style.display = 'flex';
                    imageGrid.style.gap = '10px';
                    imageGrid.style.flexWrap = 'wrap';
                    imageGrid.style.marginTop = '10px';
                    msg.images.forEach(imageSrc => {
                        const imgEl = document.createElement('img');
                        imgEl.src = imageSrc;
                        imgEl.className = 'generated-image';
                        imgEl.addEventListener('click', () => {
                            imageModal.style.display = 'flex';
                            modalImage.src = imgEl.src;
                        });
                        imageGrid.appendChild(imgEl);
                    });
                    content.appendChild(imageGrid);
                }
                
                if (msg.videoUrl) {
                    const videoContainer = document.createElement('div');
                    videoContainer.style.marginTop = '10px';
                    
                    const videoEl = document.createElement('video');
                    videoEl.src = msg.videoUrl;
                    videoEl.controls = true;
                    videoEl.autoplay = false;
                    videoEl.style.maxWidth = '400px';
                    videoEl.style.maxHeight = '400px';
                    videoEl.style.borderRadius = '8px';
                    videoEl.style.width = '100%';
                    
                    const videoActions = document.createElement('div');
                    videoActions.className = 'video-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '‚úèÔ∏è Edit';
                    editBtn.className = 'action-btn';
                    editBtn.style.cssText = 'background: var(--accent1); color: white;';
                    editBtn.onclick = () => showReplyInput('/video');
                    
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = '‚¨áÔ∏è Download MP4';
                    downloadBtn.className = 'action-btn';
                    downloadBtn.style.cssText = 'background: var(--green-neon); color: #000;';
                    downloadBtn.onclick = () => downloadVideo(msg.videoUrl, msg.videoPrompt || 'video');
                    
                    videoActions.appendChild(editBtn);
                    videoActions.appendChild(downloadBtn);
                    
                    videoContainer.appendChild(videoEl);
                    videoContainer.appendChild(videoActions);
                    content.appendChild(videoContainer);
                }
                
                // Add reply button for bot messages
                if (msg.role === 'bot' && msg.replyContext) {
                    const replyBtn = document.createElement('button');
                    replyBtn.className = 'reply-btn';
                    replyBtn.innerHTML = '‚Ü©Ô∏è Reply';
                    replyBtn.style.cssText = 'background: rgba(122,43,255,0.2); border: 1px solid var(--accent1); color: var(--neon); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 10px; transition: all 0.2s;';
                    replyBtn.addEventListener('mouseenter', () => {
                        replyBtn.style.background = 'var(--accent1)';
                        replyBtn.style.color = 'white';
                    });
                    replyBtn.addEventListener('mouseleave', () => {
                        replyBtn.style.background = 'rgba(122,43,255,0.2)';
                        replyBtn.style.color = 'var(--neon)';
                    });
                    replyBtn.addEventListener('click', () => {
                        showReplyInput(msg.replyContext);
                    });
                    content.appendChild(replyBtn);
                }
            }
            bubble.appendChild(icon);
            bubble.appendChild(content);
            messageArea.appendChild(bubble);
        });
        messageArea.scrollTop = messageArea.scrollHeight;
    };

    const showWelcomeScreen = () => { 
        stopCryptoRefresh(); 
        resetInputUI(); 
        activeChatId = null; 
        welcomeScreen.style.display = 'flex'; 
        messageArea.style.display = 'none'; 
        chatInputElement.placeholder = 'Start a new conversation...'; 
        renderChatList(); 
        clearImagePreviews();
        
        // Clear reply context
        currentReplyContext = null;
        document.getElementById('reply-bar').style.display = 'none';
        
        // Remove active states from footer tabs and show composer
        document.querySelector('.footer-tab[onclick="showAbout()"]').classList.remove('active');
        document.querySelector('.footer-tab[onclick="showHelp()"]').classList.remove('active');
        document.querySelector('.footer-tab[onclick="showDevPortal()"]').classList.remove('active');
        document.querySelector('.composer').style.display = 'block';
    };
    const showTypingIndicator = () => { 
        const ind = document.createElement('div'); 
        ind.className = 'message-bubble bot-message typing-indicator'; 
        ind.innerHTML = `<div class="icon"><div class="status-orb">...</div></div><div class="message-content"><span></span><span></span><span></span></div>`; 
        messageArea.appendChild(ind); 
        messageArea.scrollTop = messageArea.scrollHeight; 
    };
    const removeTypingIndicator = () => { const ind = messageArea.querySelector('.typing-indicator'); if (ind) ind.remove(); };
    const selectChat = (id) => { 
        if (id === 'about' || id === 'help') return; // Prevent selecting about/help as chats
        
        stopCryptoRefresh(); 
        resetInputUI(); 
        activeChatId = id; 
        renderChatContent(); 
        renderChatList(); 
        chatInputElement.placeholder = 'Type your message...';
        
        // Remove active states from footer tabs and show composer
        document.querySelector('.footer-tab[onclick="showAbout()"]').classList.remove('active');
        document.querySelector('.footer-tab[onclick="showHelp()"]').classList.remove('active');
        document.querySelector('.composer').style.display = 'block';
    };
    
    const handleImageAttachment = (files) => {
        for(let file of files) {
            if (!file || !file.type.startsWith('image/')) continue;
            const reader = new FileReader();
            reader.onload = (e) => {
                attachedImages.push({ base64: e.target.result, mimeType: file.type });
                renderImagePreviews();
            };
            reader.readAsDataURL(file);
        }
    };

    const renderImagePreviews = () => {
        imagePreviewContainer.innerHTML = '';
        attachedImages.forEach((image, index) => {
            const item = document.createElement('div');
            item.className = 'image-preview-item';
            const img = document.createElement('img');
            img.src = image.base64;
            const rmBtn = document.createElement('button');
            rmBtn.className = 'remove-img-btn';
            rmBtn.textContent = 'X';
            rmBtn.onclick = () => {
                attachedImages.splice(index, 1);
                renderImagePreviews();
            };
            item.appendChild(img);
            item.appendChild(rmBtn);
            imagePreviewContainer.appendChild(item);
        });
    };

    const clearImagePreviews = () => {
        attachedImages = [];
        fileUploadInput.value = '';
        renderImagePreviews();
    };

    const toggleOnlineStatus = () => { isOffline = !isOffline; appContainer.classList.toggle('offline', isOffline); statusTextElement.textContent = isOffline ? 'Offline' : 'Online'; statusToggleButton.title = isOffline ? 'Go Online' : 'Go Offline'; chatInputElement.disabled = isOffline; sendBtn.disabled = isOffline; chatInputElement.placeholder = isOffline ? 'AI is offline.' : (activeChatId ? 'Type your message...' : 'Start a new conversation...'); };

async function getBotResponse(userMessage) {
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: userMessage,  // Make sure this line exists and userMessage has a value
                messages: chatHistory || []  // Include chat history if you have it
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data.text || 'No response received';
        
    } catch (error) {
        console.error('Error calling chat API:', error);
        return 'Sorry, I encountered an error. Please try again.';
    }
}

// Also check your handleSendMessage function around line 1467
function handleSendMessage() {
    const messageInput = document.getElementById('messageInput'); // or whatever your input ID is
    const userMessage = messageInput.value.trim();
    
    if (!userMessage) {
        return; // Don't send empty messages
    }
    
    // Clear the input
    messageInput.value = '';
    
    // Add user message to chat
    addMessageToChat(userMessage, 'user');
    
    // Get bot response
    getBotResponse(userMessage).then(botResponse => {
        addMessageToChat(botResponse, 'bot');
    });
}
    
    const showCommandBuilder = (command) => {
        commandMode = command;
        chatInputWrapper.style.display = 'none';
        commandBuilder.style.display = 'flex';
        let builderHTML = `<span class="cmd-name">${command.name}</span>`;
        command.params.forEach(param => {
            builderHTML += `<div class="param-input-box"><input type="text" class="param-input" id="param-${param.name}" placeholder="${param.name}"></div>`;
        });
        commandBuilder.innerHTML = builderHTML;
        const firstInput = commandBuilder.querySelector('.param-input');
        if (firstInput) {
            firstInput.focus();
            firstInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } 
                else if (e.key === 'Backspace' && firstInput.value === '') { e.preventDefault(); resetInputUI(); }
            });
        }
    };

    const resetInputUI = () => {
        commandMode = null;
        commandBuilder.style.display = 'none';
        chatInputWrapper.style.display = 'flex';
        chatInputElement.value = '';
        chatInputElement.focus();
    };

    const renderCommands = (filteredCommands) => {
        commandSelector.innerHTML = '';
        filteredCommands.forEach(cmd => {
            const item = document.createElement('div');
            item.className = 'command-item';
            item.innerHTML = `<div class="command-icon">${cmd.icon}</div><div><div class="command-name">${cmd.name}</div><div class="command-desc">${cmd.description}</div></div>`;
            item.addEventListener('click', () => {
                commandSelector.style.display = 'none';
                if (cmd.params && cmd.name !== '/recipe') {
                    showCommandBuilder(cmd);
                } else {
                    chatInputElement.value = cmd.name;
                    handleSendMessage();
                }
            });
            commandSelector.appendChild(item);
        });
    };

    const handleSendMessage = async () => {
        stopCryptoRefresh();
        let messageText = '';
        if (commandMode) {
            const paramInput = document.getElementById(`param-${commandMode.params[0].name}`);
            messageText = `${commandMode.name} ${paramInput.value.trim()}`;
        } else {
            messageText = chatInputElement.value.trim();
        }
        if ((!messageText && attachedImages.length === 0) || isOffline) return;
        resetInputUI();
        let currentChat;
        if (activeChatId === null) {
            const newChatId = Date.now().toString();
            const newChat = { id: newChatId, title: "New Chat", messages: [] };
            chats.push(newChat);
            activeChatId = newChatId;
            currentChat = newChat;
            renderChatList();
            
            // Generate intelligent title
            generateChatTitle(messageText, newChatId);
        } else {
            currentChat = chats.find(c => c.id === activeChatId);
        }
        const imagesForApi = [...attachedImages];
        const userMessage = { 
            role: 'user', 
            text: messageText, 
            images: imagesForApi.map(img => img.base64),
            originalCommand: messageText.startsWith('/') ? messageText.split(' ')[0] : null,
            replyTo: currentReplyContext
        };
        
        // Clear reply context after using it
        if (currentReplyContext) {
            cancelReply();
        }
        currentChat.messages.push(userMessage);
        const historyForApi = currentChat.messages.slice(0, -1).map(msg => ({
             role: msg.role, text: msg.text
        }));
        const promptForApi = messageText;
        clearImagePreviews();
        renderChatContent();
        abortController = new AbortController();
        let botResponseData;
        try {
            if (promptForApi.toLowerCase().startsWith('/image')) {
                const imagePrompt = promptForApi.substring(6).trim();
                await handleImageCommand(imagePrompt);
                return;
            } else if (promptForApi.toLowerCase().startsWith('/video')) {
                const videoPrompt = promptForApi.substring(6).trim();
                await handleVideoCommand(videoPrompt);
                return;
            } else if (promptForApi.toLowerCase().startsWith('/crypto')) {
                 const coin = promptForApi.substring(7).trim();
                 await handleCryptoCommand(coin);
                 return;
            } else if (promptForApi.toLowerCase().startsWith('/design')) {
                await handleDesignCommand();
                return;
            } else if (promptForApi.toLowerCase().startsWith('/study')) {
                const topic = promptForApi.substring(6).trim();
                await handleStudyCommand(topic);
                return;
            } else if (promptForApi.toLowerCase().startsWith('/quiz')) {
                const topic = promptForApi.substring(5).trim();
                await handleQuizCommand(topic);
                return;
            } else if (promptForApi.toLowerCase().startsWith('/schedule')) {
                const schedulePrompt = promptForApi.substring(9).trim();
                await handleScheduleCommand(schedulePrompt);
                return;
            } else if (promptForApi.toLowerCase().startsWith('/whiteboard')) {
                const topic = promptForApi.substring(11).trim();
                await handleWhiteboardCommand(topic);
                return;
            } else if (promptForApi.toLowerCase().startsWith('/recipe')) {
                const ingredients = promptForApi.substring(7).trim();
                await handleRecipeCommand(ingredients);
                return;
            } else if (promptForApi.toLowerCase() === '/clear') {
                currentChat.messages = [];
                renderChatContent();
                return;
            }
            showTypingIndicator();
            let contextPrompt = promptForApi;
            if (userMessage.replyTo) {
                contextPrompt = `[User is replying to a previous ${userMessage.replyTo} command] ${promptForApi}`;
            }
            const response = await getBotResponse(contextPrompt, imagesForApi, historyForApi, abortController.signal);
            removeTypingIndicator();
            if (response === null) {
                botResponseData = { role: 'bot', text: 'Ok, I\'ve stopped.' };
            } else if (response.error) {
                botResponseData = { role: 'bot', text: response.error.message };
            } else {
                let responseText = response.text || "Sorry, I couldn't get a response.";
                if (userMessage.replyTo) {
                    responseText = `*Continuing from ${userMessage.replyTo}:*\n\n${responseText}`;
                }
                botResponseData = { 
                    role: 'bot', 
                    text: responseText,
                    replyContext: userMessage.originalCommand
                };
            }
            currentChat.messages.push(botResponseData);
            renderChatContent();
            saveChats();
        } catch(error) {
            removeTypingIndicator();
            currentChat.messages.push({ role: 'bot', text: 'Something went wrong. Please try again.' });
            renderChatContent();
        } finally {
            abortController = null;
        }
    };
    
    // --- SPECIAL COMMAND HANDLERS ---
    
    const stopCryptoRefresh = () => { if (cryptoRefreshInterval) clearInterval(cryptoRefreshInterval); cryptoRefreshInterval = null; };

    const toggleCryptoRefresh = (btn, messageId) => {
        if (cryptoRefreshInterval) {
            stopCryptoRefresh();
            btn.textContent = 'Auto-Refresh';
            btn.classList.remove('active');
        } else {
            const refresh = () => fetchCryptoData(messageId, true);
            cryptoRefreshInterval = setInterval(refresh, 30000);
            btn.textContent = 'Stop Refresh';
            btn.classList.add('active');
        }
    };
    
    const formatPrice = (price) => {
        if (price === null || price === undefined) return 'N/A';
        return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 });
    };

    const updateBotMessage = (htmlContent, messageId) => {
        let messageElement = document.getElementById(messageId);
        if (!messageElement) {
            renderChatContent();
            messageElement = document.getElementById(messageId);
        }
        if (messageElement) {
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.innerHTML = htmlContent;
            const refreshBtn = contentElement.querySelector('#crypto-refresh-btn');
            if(refreshBtn) refreshBtn.onclick = () => toggleCryptoRefresh(refreshBtn, messageId);
        }
        const chat = chats.find(c => c.id === activeChatId);
        const msg = chat?.messages.find(m => m.id === messageId);
        if (msg) {
            msg.text = htmlContent;
            saveChats();
        }
    };
    
    const fetchCryptoData = async (messageId, isRefresh = false) => {
        try {
            const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=30&page=1&sparkline=false`);
            if (!response.ok) { throw new Error('Could not connect to CoinGecko API.'); }
            const data = await response.json();
            let recsHtml = `<div class="crypto-header"><h3>Top Movers & Shakers üöÄ</h3><button id="crypto-refresh-btn">Auto-Refresh</button></div><div class="crypto-recommendations">`;
            for(let i=0; i<3; i++) {
                const coin = data[i];
                const change = coin.price_change_percentage_24h;
                const priceClass = change >= 0 ? 'price-up' : 'price-down';
                recsHtml += `<div class="crypto-rec-card"><img src="${coin.image}" alt="${coin.name}" class="crypto-icon"><div class="crypto-name">${coin.name}</div><div class="crypto-price">${formatPrice(coin.current_price)}</div><div class="crypto-change ${priceClass}">${change.toFixed(2)}%</div></div>`;
            }
            recsHtml += '</div><hr class="crypto-divider">';
            let listHtml = '<ul class="crypto-list">';
            data.forEach(coin => {
                const price = coin.current_price;
                const oldPrice = lastCryptoPrices[coin.id] || price;
                let priceClass = '';
                if (isRefresh) {
                    if (price > oldPrice) priceClass = 'price-up';
                    if (price < oldPrice) priceClass = 'price-down';
                } else {
                    priceClass = coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down';
                }
                lastCryptoPrices[coin.id] = price;
                listHtml += `<li class="crypto-list-item"><img src="${coin.image}" alt="${coin.name}" class="crypto-icon"><div class="crypto-info"><div class="crypto-name">${coin.name}</div><div class="crypto-symbol">${coin.symbol.toUpperCase()}</div></div><div class="crypto-price-details"><div class="crypto-price ${priceClass}">${formatPrice(price)}</div><div class="crypto-change ${coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}">${coin.price_change_percentage_24h.toFixed(2)}%</div></div></li>`;
            });
            listHtml += '</ul>';
            const msg = currentChat.messages.find(m => m.id === activeChatId)?.messages.find(m => m.id === messageId);
            if (msg) msg.replyContext = '/crypto';
            updateBotMessage(recsHtml + listHtml, messageId);
        } catch (error) {
             updateBotMessage(`Sorry, I couldn't fetch the crypto data. ${error.message}`, messageId);
        }
    };

    const handleImageCommand = async (prompt) => {
        if (!prompt) {
            const currentChat = chats.find(c => c.id === activeChatId);
            currentChat.messages.push({ role: 'bot', text: 'Please provide a prompt for image generation. Example: `/image a futuristic car`' });
            renderChatContent();
            return;
        }
        
        const messageId = `image-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        
        currentChat.messages.push({ id: messageId, role: 'bot', text: 'Generating your image...', isImageLoading: true });
        renderChatContent();
        
        try {
            const response = await fetch('/api/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to generate image');
            }
            
            const data = await response.json();
            const imageBase64 = `data:image/png;base64,${data.imageBase64}`;
            
            const msg = currentChat.messages.find(m => m.id === messageId);
            if (msg) {
                msg.text = `Here's your generated image for: "${prompt}"`;
                msg.images = [imageBase64];
                msg.isImageLoading = false;
                msg.replyContext = '/image';
            }
            
            renderChatContent();
            saveChats();
            
        } catch (error) {
            const msg = currentChat.messages.find(m => m.id === messageId);
            if (msg) {
                msg.text = `Sorry, I couldn't generate the image. ${error.message}`;
                msg.isImageLoading = false;
            }
            renderChatContent();
        }
    };

    const handleVideoCommand = async (prompt) => {
        if (!prompt) {
            const currentChat = chats.find(c => c.id === activeChatId);
            currentChat.messages.push({ role: 'bot', text: 'Please provide a prompt for video generation. Example: `/video a cat playing piano`' });
            renderChatContent();
            return;
        }
        
        const messageId = `video-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        
        const qualityPanel = `<div class="video-quality-panel" id="quality-panel-${messageId}">
            <h3>üé¨ Video Quality Selection</h3>
            <p>Choose quality for: "${prompt}"</p>
            <div class="quality-options">
                <button onclick="generateVideoWithQuality('${messageId}', '${prompt}', '320p')" class="quality-btn">320p - Fast</button>
                <button onclick="generateVideoWithQuality('${messageId}', '${prompt}', '480p')" class="quality-btn">480p - Good</button>
                <button onclick="generateVideoWithQuality('${messageId}', '${prompt}', '720p')" class="quality-btn quality-recommended">720p - Recommended</button>
                <button onclick="generateVideoWithQuality('${messageId}', '${prompt}', '1080p')" class="quality-btn">1080p - Best</button>
            </div>
        </div>`;
        
        currentChat.messages.push({ id: messageId, role: 'bot', text: qualityPanel, replyContext: '/video' });
        renderChatContent();
        saveChats();
    };
    
    window.generateVideoWithQuality = async (messageId, prompt, quality) => {
        const currentChat = chats.find(c => c.id === activeChatId);
        const msg = currentChat.messages.find(m => m.id === messageId);
        
        if (msg) {
            msg.text = `üé¨ Generating ${quality} video...`;
            msg.isVideoLoading = true;
        }
        renderChatContent();
        
        try {
            const response = await fetch('/api/generate-video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, quality })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to generate video');
            }
            
            const data = await response.json();
            
            if (msg) {
                msg.text = `üé¨ Video generated in ${quality} for: "${prompt}"`;
                msg.videoUrl = data.videoUrl;
                msg.videoPrompt = prompt;
                msg.videoQuality = quality;
                msg.isVideoLoading = false;
            }
            
            renderChatContent();
            saveChats();
            
        } catch (error) {
            if (msg) {
                msg.text = `Sorry, I couldn't generate the video. ${error.message}`;
                msg.isVideoLoading = false;
            }
            renderChatContent();
        }
    };

    const handleCryptoCommand = async (coin) => {
        const messageId = `crypto-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        currentChat.messages.push({ id: messageId, role: 'bot', text: 'Fetching crypto data...' });
        renderChatContent();
        if (coin) {
             try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coin.toLowerCase()}`);
                if (!response.ok) { throw new Error('Coin not found. Please use the coin ID (e.g., "bitcoin", not "BTC").'); }
                const data = await response.json();
                const price = data.market_data.current_price.usd;
                const change = data.market_data.price_change_percentage_24h;
                const priceClass = change >= 0 ? 'price-up' : 'price-down';
                const content = `<div class="crypto-container"><h3><img src="${data.image.small}" alt="${data.name}" class="crypto-icon" /> ${data.name} (${data.symbol.toUpperCase()})</h3><p>Price: <span class="${priceClass}">${formatPrice(price)}</span></p><p>Market Cap: ${formatPrice(data.market_data.market_cap.usd)}</p><p>24h Change: <span class="${priceClass}">${change.toFixed(2)}%</span></p></div>`;
                updateBotMessage(content, messageId);
            } catch (error) {
                 updateBotMessage(`Sorry, I couldn't fetch the data for that coin. ${error.message}`, messageId);
            }
        } else {
            lastCryptoPrices = {};
            await fetchCryptoData(messageId);
        }
    };
    
    const handleDesignCommand = async () => {
        const messageId = `design-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        const designOptions = [
            { icon: 'üìä', title: 'PPT', url: 'https://www.canva.com/presentations/templates/' },
            { icon: 'üé®', title: 'Logo', url: 'https://www.canva.com/logos/templates/' },
            { icon: 'üñºÔ∏è', title: 'Poster', url: 'https://www.canva.com/posters/templates/' },
            { icon: '‚ú®', title: 'AI Image to Video', url: 'https://www.canva.com/ai-image-generator/' },
            { icon: 'üìù', title: 'Text to Image', url: 'https://www.canva.com/ai-image-generator/' },
            { icon: 'üé¨', title: 'Text to Video', url: 'https://www.canva.com/videos/' }
        ];
        let menuHtml = '<h3>Create a new design with Canva</h3><div class="design-menu">';
        designOptions.forEach(opt => {
            menuHtml += `<a href="${opt.url}" target="_blank" class="design-menu-item"><div class="design-icon">${opt.icon}</div><div class="design-title">${opt.title}</div></a>`;
        });
        menuHtml += '</div>';
        currentChat.messages.push({ id: messageId, role: 'bot', text: menuHtml, replyContext: '/design' });
        renderChatContent();
        saveChats();
    };

    const handleScheduleCommand = async (prompt) => {
        if (!prompt) {
            const currentChat = chats.find(c => c.id === activeChatId);
            currentChat.messages.push({ role: 'bot', text: 'Please provide a schedule request. Example: `/schedule morning routine` or `/schedule study plan for exams`' });
            renderChatContent();
            return;
        }
        
        const messageId = `schedule-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        
        currentChat.messages.push({ id: messageId, role: 'bot', text: `üìÖ Creating schedule for: "${prompt}"...` });
        renderChatContent();
        
        try {
            const schedulePrompt = `Create a detailed schedule/routine table for: "${prompt}". Format as HTML table with proper styling. Include time slots, activities, and brief descriptions. Make it practical and well-organized.`;
            
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: schedulePrompt, history: [] })
            });
            
            if (!response.ok) {
                throw new Error('Failed to generate schedule');
            }
            
            const data = await response.json();
            let scheduleHtml = `<div class="schedule-container">
                <h3>üìÖ ${prompt.charAt(0).toUpperCase() + prompt.slice(1)} Schedule</h3>
                <div class="schedule-content" id="schedule-content-${messageId}">
                    ${data.text}
                </div>
                <div class="schedule-actions">
                    <button class="action-btn copy-btn" onclick="copySchedule('${messageId}')" title="Copy to clipboard">üìã Copy</button>
                    <button class="action-btn edit-btn" onclick="editSchedule('${messageId}')" title="Edit schedule">‚úèÔ∏è Edit</button>
                    <button class="action-btn regen-btn" onclick="regenerateSchedule('${messageId}', '${prompt}')" title="Generate new version">üîÑ Regenerate</button>
                </div>
            </div>`;
            
            const msg = currentChat.messages.find(m => m.id === messageId);
            if (msg) {
                msg.text = scheduleHtml;
                msg.replyContext = '/schedule';
            }
            updateBotMessage(scheduleHtml, messageId);
            
        } catch (error) {
            updateBotMessage(`Sorry, I couldn't generate the schedule. ${error.message}`, messageId);
        }
    };
    
    // --- STUDY & QUIZ ---
    const handleStudyCommand = async (topic) => {
        if (!topic) { return; }
        const messageId = `study-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        currentChat.messages.push({ id: messageId, role: 'bot', text: `üìö Generating study guide for **${topic}**...` });
        renderChatContent();
        
        try {
            const studyPrompt = `Create a comprehensive study guide for the topic: "${topic}". Format your response as HTML with the following structure:
            - A brief summary paragraph
            - Key concepts and explanations
            - Important highlights as bullet points
            - Any formulas, dates, or key facts
            Make it educational and easy to understand.`;
            
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: studyPrompt, history: [] })
            });
            
            if (!response.ok) {
                throw new Error('Failed to generate study guide');
            }
            
            const data = await response.json();
            let studyHtml = `<div class="study-guide-container">
                <h2>üìö Study Guide: ${topic}</h2>
                ${data.text}
                <div style="text-align: center; margin-top: 20px;">
                    <button class="welcome-btn" onclick="openQuizPanel('${topic}', '${messageId}')">üß† Take a Quiz</button>
                </div>
                <div id="quiz-panel-${messageId}" style="display: none; margin-top: 20px;"></div>
            </div>`;
            
            const msg = currentChat.messages.find(m => m.id === messageId);
            if (msg) {
                msg.text = studyHtml;
                msg.replyContext = '/study';
            }
            updateBotMessage(studyHtml, messageId);
            
        } catch (error) {
            updateBotMessage(`Sorry, I couldn't generate a study guide for "${topic}". ${error.message}`, messageId);
        }
    };

    const handleQuizCommand = async (topic) => {
        if (!topic) { return; }
        const messageId = `quiz-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;

        const setupHTML = getQuizSetupHTML(topic, messageId);
        currentChat.messages.push({ id: messageId, role: 'bot', text: setupHTML, replyContext: '/quiz' });
        renderChatContent();
    };

    window.openQuizPanel = (topic, messageId) => {
        const panel = document.getElementById(`quiz-panel-${messageId}`);
        if (panel) {
            panel.style.display = 'block';
            panel.innerHTML = getQuizSetupHTML(topic, `${messageId}-quiz`);
        }
    };
    
    window.getQuizSetupHTML = (topic, messageId) => {
        return `<div id="quiz-setup-panel-${messageId}" class="quiz-setup-panel">
            <h3>üß† Take a quiz on ${topic}!</h3>
            <div class="quiz-setup-section">
                <label>Difficulty</label>
                <div class="difficulty-btns">
                    <button id="difficulty-easy-${messageId}" onclick="selectDifficulty('easy', '${messageId}')" class="selected">Easy</button>
                    <button id="difficulty-medium-${messageId}" onclick="selectDifficulty('medium', '${messageId}')">Medium</button>
                    <button id="difficulty-hard-${messageId}" onclick="selectDifficulty('hard', '${messageId}')">Hard</button>
                </div>
            </div>
            <div class="quiz-setup-section">
                <label for="q-count-${messageId}">Number of Questions: <span id="q-count-label-${messageId}">5</span></label>
                <div class="slider-container">
                    <span>3</span>
                    <input type="range" min="3" max="10" value="5" id="q-count-${messageId}" oninput="document.getElementById('q-count-label-${messageId}').textContent = this.value">
                    <span>10</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="welcome-btn" onclick="cancelQuiz('${messageId}')" style="background: var(--red-neon);">Cancel</button>
                <button class="welcome-btn" onclick="startCustomQuiz('${topic}', '${messageId}')">Take Quiz!</button>
            </div>
        </div>`;
    };

    window.cancelQuiz = (messageId) => {
        const panel = document.getElementById(`quiz-panel-${messageId.replace('-quiz', '')}`);
        if (panel) panel.style.display = 'none';
    };

    window.nextQuestion = () => {
        const { quiz } = currentQuizState;
        currentQuizState.currentQuestionIndex++;
        if (currentQuizState.currentQuestionIndex < quiz.questions.length) {
            renderQuizQuestion();
        } else {
            showQuizResults();
        }
    };

    const generateChatTitle = async (userMessage, chatId) => {
        try {
            const titlePrompt = `Generate a short, descriptive chat title (max 4-6 words) for this user message: "${userMessage}". Examples: "Bitcoin Price Inquiry", "Python Study Guide", "Image Generation Request". Return only the title, nothing else.`;
            
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: titlePrompt, history: [] })
            });
            
            if (response.ok) {
                const data = await response.json();
                const title = data.text.replace(/["']/g, '').trim().substring(0, 40);
                
                const chat = chats.find(c => c.id === chatId);
                if (chat) {
                    chat.title = title || userMessage.substring(0, 30);
                    renderChatList();
                    saveChats();
                }
            }
        } catch (error) {
            // Fallback to original method if API fails
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                chat.title = userMessage.substring(0, 30) || "New Chat";
                renderChatList();
                saveChats();
            }
        }
    };
    
    window.selectDifficulty = (level, messageId) => {
        ['easy', 'medium', 'hard'].forEach(l => document.getElementById(`difficulty-${l}-${messageId}`).classList.remove('selected'));
        document.getElementById(`difficulty-${level}-${messageId}`).classList.add('selected');
    };

    window.startCustomQuiz = async (topic, messageId) => {
        const difficulty = document.querySelector(`#quiz-setup-panel-${messageId} .difficulty-btns .selected`).textContent.toLowerCase();
        const questionCount = document.getElementById(`q-count-${messageId}`).value;
        
        const quizContainer = `<div id="quiz-container-${messageId}" class="quiz-setup-panel">
            <div class="quiz-header">
                <h3>üß† ${topic} Quiz</h3>
                <div class="quiz-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-${messageId}" style="width: 0%;"></div>
                    </div>
                    <span id="progress-text-${messageId}">Question 1 of ${questionCount}</span>
                </div>
            </div>
            <div id="quiz-content-${messageId}">Generating quiz questions...</div>
        </div>`;
        
        if (messageId.includes('-quiz')) {
            const panel = document.getElementById(`quiz-panel-${messageId.replace('-quiz', '')}`);
            if (panel) panel.innerHTML = quizContainer;
        } else {
            updateBotMessage(quizContainer, messageId);
        }
        
        try {
            const quizPrompt = `Generate a ${difficulty} difficulty quiz about "${topic}" with exactly ${questionCount} multiple choice questions. Format as JSON with this structure:
            {
              "questions": [
                {
                  "question": "Question text",
                  "options": ["Option A", "Option B", "Option C", "Option D"],
                  "correct": 0,
                  "explanation": "Brief explanation of the answer"
                }
              ]
            }
            Make questions appropriate for ${difficulty} level. Return ONLY the JSON, no other text.`;
            
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: quizPrompt, history: [] })
            });
            
            const data = await response.json();
            let quizData;
            try {
                const jsonMatch = data.text.match(/\{[\s\S]*\}/);
                quizData = JSON.parse(jsonMatch ? jsonMatch[0] : data.text);
            } catch {
                throw new Error('Failed to parse quiz data');
            }
            
            currentQuizState = {
                quiz: quizData,
                messageId,
                topic,
                currentQuestionIndex: 0,
                score: 0,
                wrongAnswers: [],
                totalQuestions: quizData.questions.length
            };
            
            renderQuizQuestion();
            
        } catch (error) {
            const errorMsg = `Sorry, couldn't generate the quiz. ${error.message}`;
            if (messageId.includes('-quiz')) {
                const panel = document.getElementById(`quiz-panel-${messageId.replace('-quiz', '')}`);
                if (panel) panel.innerHTML = `<p style="color: var(--red-neon);">${errorMsg}</p>`;
            } else {
                updateBotMessage(errorMsg, messageId);
            }
        }
    };

    const startQuiz = (quizData, messageId) => {
        currentQuizState = { quiz: quizData, messageId, currentQuestionIndex: 0, score: 0, wrongAnswers: [] };
        renderQuizQuestion();
    };

    const renderQuizQuestion = () => {
        const { quiz, messageId, currentQuestionIndex, totalQuestions } = currentQuizState;
        const questionData = quiz.questions[currentQuestionIndex];
        const quizContent = document.getElementById(`quiz-content-${messageId}`);
        const progressFill = document.getElementById(`progress-${messageId}`);
        const progressText = document.getElementById(`progress-text-${messageId}`);
        
        if (!quizContent) return;
        
        // Update progress
        const progress = ((currentQuestionIndex) / totalQuestions) * 100;
        const questionsLeft = totalQuestions - currentQuestionIndex;
        if (progressFill) progressFill.style.width = `${progress}%`;
        if (progressText) progressText.textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions} ‚Ä¢ ${questionsLeft} left`;
        
        let quizHtml = `<div class="quiz-question" style="margin-bottom: 25px;">${questionData.question}</div>
            <div class="quiz-options">`;
        questionData.options.forEach((option, index) => {
            const letter = String.fromCharCode(65 + index); // A, B, C, D
            quizHtml += `<button class="quiz-option" onclick="checkAnswer(${currentQuestionIndex}, ${index})" style="margin-bottom: 12px;"><strong>${letter}.</strong> ${option}</button>`;
        });
        quizHtml += `</div>`;
        quizContent.innerHTML = quizHtml;
    };
    
    window.checkAnswer = (questionIndex, optionIndex) => {
        const { quiz, messageId } = currentQuizState;
        const questionData = quiz.questions[questionIndex];
        const options = document.querySelectorAll(`#quiz-content-${messageId} .quiz-option`);
        options.forEach(opt => opt.disabled = true);
        
        const isCorrect = optionIndex === questionData.correct;
        
        if (isCorrect) {
            currentQuizState.score++;
            options[optionIndex].classList.add('correct');
            // Correct animation
            options[optionIndex].style.transform = 'scale(1.05)';
            options[optionIndex].style.boxShadow = '0 0 20px var(--green-neon)';
        } else {
            options[optionIndex].classList.add('wrong');
            options[questionData.correct].classList.add('correct');
            currentQuizState.wrongAnswers.push({ 
                question: questionData.question, 
                correct: questionData.options[questionData.correct],
                explanation: questionData.explanation || 'No explanation provided'
            });
            // Wrong animation
            options[optionIndex].style.transform = 'scale(0.95)';
            options[optionIndex].style.boxShadow = '0 0 20px var(--red-neon)';
        }
        
        setTimeout(() => {
            currentQuizState.currentQuestionIndex++;
            if (currentQuizState.currentQuestionIndex < quiz.questions.length) {
                renderQuizQuestion();
            } else {
                showQuizResults();
            }
        }, 2500);
    };

    const showQuizResults = async () => {
        const { quiz, messageId, score, wrongAnswers, topic, totalQuestions } = currentQuizState;
        const quizContainer = document.getElementById(`quiz-container-${messageId}`);
        if (!quizContainer) return;
        
        const percentage = Math.round((score / totalQuestions) * 100);
        let performanceLevel = percentage >= 80 ? 'Excellent!' : percentage >= 60 ? 'Good job!' : 'Keep practicing!';
        
        let resultsHtml = `<div class="quiz-results">
            <h3>üéâ Quiz Complete!</h3>
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 2em; color: var(--neon);">${score}/${totalQuestions}</div>
                <div style="font-size: 1.2em; margin: 10px 0;">${percentage}% - ${performanceLevel}</div>
            </div>`;
        
        if (wrongAnswers.length > 0) {
            resultsHtml += `<h4 style="color: var(--red-neon);">üìù Review These:</h4>`;
            wrongAnswers.forEach(wa => {
                resultsHtml += `<div style="background: rgba(255,59,59,0.1); padding: 10px; margin: 8px 0; border-radius: 8px; border-left: 3px solid var(--red-neon);">
                    <strong>Q:</strong> ${wa.question}<br>
                    <strong>Correct Answer:</strong> ${wa.correct}<br>
                    <small style="color: #ccc;">${wa.explanation}</small>
                </div>`;
            });
            
            // Get AI recommendation
            try {
                const recommendationPrompt = `User scored ${score}/${totalQuestions} on "${topic}" quiz. Give 2 short, specific study tips (max 2 sentences each) for improvement. Keep it brief and actionable.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: recommendationPrompt, history: [] })
                });
                
                const data = await response.json();
                resultsHtml += `<h4 style="color: var(--neon);">ü§ñ AI Recommendations:</h4>
                    <div style="background: rgba(122,43,255,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--neon);">
                        ${data.text}
                    </div>`;
            } catch (error) {
                resultsHtml += `<h4 style="color: var(--neon);">üí° Keep studying ${topic} to improve!</h4>`;
            }
        } else {
            resultsHtml += `<div style="background: rgba(0,255,106,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--green-neon);">
                <h4 style="color: var(--green-neon);">üéØ Perfect Score!</h4>
                <p>Amazing work! You've mastered this topic. Ready for a harder challenge?</p>
            </div>`;
        }
        
        resultsHtml += `</div>`;
        quizContainer.innerHTML = resultsHtml;
    };





    const handlePaste = (event) => {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                const file = item.getAsFile();
                handleImageAttachment([file]);
                event.preventDefault(); 
                return;
            }
        }
    };
    
    window.quickStart = (command) => {
        const cmdDef = commands.find(c => command.startsWith(c.name));
        if (cmdDef && cmdDef.params) {
            showCommandBuilder(cmdDef);
        } else {
            chatInputElement.value = command;
            handleSendMessage();
        }
    };
    
    let currentReplyContext = null;
    
    const showReplyInput = (originalCommand) => {
        currentReplyContext = originalCommand;
        const replyBar = document.getElementById('reply-bar');
        const replyText = document.getElementById('reply-text');
        replyText.textContent = `‚Ü©Ô∏è Replying to ${originalCommand} message`;
        replyBar.style.display = 'flex';
        chatInputElement.focus();
    };
    
    window.cancelReply = () => {
        currentReplyContext = null;
        document.getElementById('reply-bar').style.display = 'none';
    };
    
    window.downloadVideo = (videoUrl, filename) => {
        const link = document.createElement('a');
        link.href = videoUrl;
        link.download = `${filename.replace(/[^a-z0-9]/gi, '_')}.mp4`;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };



    let currentUser = null;
    let isAdmin = false;

    const init = () => {
        // Clear reply context on page load
        currentReplyContext = null;
        document.getElementById('reply-bar').style.display = 'none';
        // Check if user is logged in
        const isLoggedIn = sessionStorage.getItem('seasworth_logged_in');
        const username = sessionStorage.getItem('seasworth_user');
        const isAdminUser = sessionStorage.getItem('seasworth_is_admin') === 'true';
        
        if (!isLoggedIn) {
            // Redirect to login page
            window.location.href = 'login.html';
            return;
        }
        
        // Set user info
        currentUser = username;
        isAdmin = isAdminUser;
        
        // Show access & support portal for all users
        document.getElementById('dev-portal-tab').style.display = 'block';

        
        loadChats();
        showWelcomeScreen();
        statusToggleButton.addEventListener('click', () => {
            if (abortController) { abortController.abort(); abortController = null; statusToggleButton.title = "Toggle AI Status"; } 
            else { toggleOnlineStatus(); }
        });
        newChatBtn.addEventListener('click', () => {
            stopCryptoRefresh(); 
            resetInputUI(); 
            activeChatId = null; 
            showWelcomeScreen();
            clearImagePreviews();
            
            // Clear reply context
            currentReplyContext = null;
            document.getElementById('reply-bar').style.display = 'none';
            
            // Remove active states from footer tabs
            document.querySelector('.footer-tab[onclick="showAbout()"]').classList.remove('active');
            document.querySelector('.footer-tab[onclick="showHelp()"]').classList.remove('active');
        });
        sendBtn.addEventListener('click', handleSendMessage);
        chatInputElement.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        chatInputElement.addEventListener('paste', handlePaste);
        chatInputElement.addEventListener('input', () => {
            const text = chatInputElement.value;
            const attachBtn = document.getElementById('attach-btn');
            if (text.startsWith('/')) {
                const searchTerm = text.substring(1).toLowerCase();
                const filtered = commands.filter(cmd => cmd.name.toLowerCase().includes(searchTerm));
                renderCommands(filtered);
                const commandsVisible = filtered.length > 0;
                commandSelector.style.display = commandsVisible ? 'block' : 'none';
                attachBtn.classList.toggle('command-mode', commandsVisible);
            } else {
                commandSelector.style.display = 'none';
                attachBtn.classList.remove('command-mode');
            }
        });
        modalClose.onclick = () => { imageModal.style.display = 'none'; };
        imageModal.onclick = (e) => { if (e.target === imageModal) imageModal.style.display = 'none'; };
        attachBtn.addEventListener('click', (e) => { e.stopPropagation(); attachmentMenu.classList.toggle('show'); });
        const triggerFileInput = (acceptType) => {
            fileUploadInput.accept = acceptType;
            fileUploadInput.multiple = true;
            fileUploadInput.click();
            attachmentMenu.classList.remove('show');
        };
        attachPhotoBtn.addEventListener('click', () => triggerFileInput('image/*'));
        attachFileBtn.addEventListener('click', () => alert('File attachments are a work in progress! For now, you can attach photos.'));
        attachVideoBtn.addEventListener('click', () => alert('Video attachments are a work in progress! For now, you can attach photos.'));
        fileUploadInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files.length > 0) {
                handleImageAttachment(e.target.files);
            }
        });
        document.addEventListener('click', () => {
            if(attachmentMenu.classList.contains('show')) {
                attachmentMenu.classList.remove('show');
            }
        });
    };



    window.showAbout = () => {
        const aboutContent = `<div class="study-guide-container">
            <h2>ü§ñ About Seasworth.AI</h2>
            <p>Seasworth.AI is your intelligent study companion and AI assistant, developed by <strong>Himesh</strong>.</p>
            <h3>Features</h3>
            <ul>
                <li>üé® <strong>Image Generation</strong> - Create images from text prompts</li>
                <li>üìö <strong>Study Guides</strong> - Generate comprehensive study materials</li>
                <li>üß† <strong>Interactive Quizzes</strong> - Test your knowledge with custom quizzes</li>
                <li>üí∞ <strong>Crypto Tracking</strong> - Real-time cryptocurrency prices</li>
                <li>üåê <strong>Web Research</strong> - Search and summarize information</li>
                <li>üé® <strong>Design Tools</strong> - Quick access to Canva templates</li>
            </ul>
            <p><strong>Version:</strong> 1.0 | <strong>Powered by:</strong> Groq AI, ClipDrop, CoinGecko</p>
        </div>`;
        
        // Set active state and show about section
        document.querySelector('.footer-tab[onclick="showAbout()"]').classList.add('active');
        document.querySelector('.footer-tab[onclick="showHelp()"]').classList.remove('active');
        document.querySelector('.composer').style.display = 'none';
        welcomeScreen.style.display = 'none';
        messageArea.style.display = 'flex';
        messageArea.innerHTML = `<div class="message-bubble bot-message"><div class="icon"><div class="status-orb"><div class="orb-core"></div><div class="orb-dot"></div><div class="orb-dot"></div><div class="orb-dot"></div></div></div><div class="message-content">${aboutContent}</div></div>`;
        activeChatId = 'about';
        renderChatList();
    };

    window.showHelp = () => {
        const helpContent = `<div class="study-guide-container">
            <h2>‚ùì Help & Commands</h2>
            <h3>Available Commands</h3>
            <ul>
                <li><code>/image [prompt]</code> - Generate an image from text</li>
                <li><code>/study [topic]</code> - Create a study guide</li>
                <li><code>/quiz [topic]</code> - Start a quiz on any topic</li>
                <li><code>/crypto [coin]</code> - Get crypto prices (optional coin name)</li>
                <li><code>/research [query]</code> - Search the web for information</li>
                <li><code>/design</code> - Access Canva design templates</li>
                <li><code>/clear</code> - Clear current chat history</li>
                <li><code>/recipe</code> - Generates a recipe for you if you do/do not have ingredients</li>
                <li><code>/whiteboard</code> - Makes a whiteboard where you can edit on</li>
                <li><code>/help</code> - Show this help message</li>
            </ul>
            <h3>Tips</h3>
            <ul>
                <li>üìé <strong>Attach Images:</strong> Click the + button to upload photos</li>
                <li>üéØ <strong>Be Specific:</strong> Detailed prompts give better results</li>
                <li>üí¨ <strong>Natural Language:</strong> Ask questions normally, no special formatting needed</li>
                <li>üîÑ <strong>New Chat:</strong> Click "New Chat" to start fresh conversations</li>
            </ul>
            <p><strong>Need more help?</strong> Just ask me anything in natural language!</p>
        </div>`;
        
        // Set active state and show help section
        document.querySelector('.footer-tab[onclick="showHelp()"]').classList.add('active');
        document.querySelector('.footer-tab[onclick="showAbout()"]').classList.remove('active');
        document.querySelector('.composer').style.display = 'none';
        welcomeScreen.style.display = 'none';
        messageArea.style.display = 'flex';
        messageArea.innerHTML = `<div class="message-bubble bot-message"><div class="icon"><div class="status-orb"><div class="orb-core"></div><div class="orb-dot"></div><div class="orb-dot"></div><div class="orb-dot"></div></div></div><div class="message-content">${helpContent}</div></div>`;
        activeChatId = 'help';
        renderChatList();
    };

    window.copySchedule = async (messageId) => {
        const content = document.getElementById(`schedule-content-${messageId}`);
        if (content) {
            const text = content.innerText;
            try {
                await navigator.clipboard.writeText(text);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = 'var(--green-neon)';
                btn.style.color = '#000';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            } catch (err) {
                alert('Failed to copy to clipboard');
            }
        }
    };

    window.editSchedule = (messageId) => {
        const content = document.getElementById(`schedule-content-${messageId}`);
        if (content) {
            const currentHtml = content.innerHTML;
            const textarea = document.createElement('textarea');
            textarea.value = content.innerText;
            textarea.style.width = '100%';
            textarea.style.minHeight = '200px';
            textarea.style.background = 'rgba(0,0,0,0.3)';
            textarea.style.color = '#fff';
            textarea.style.border = '1px solid var(--accent1)';
            textarea.style.borderRadius = '8px';
            textarea.style.padding = '12px';
            textarea.style.fontSize = '14px';
            textarea.style.fontFamily = 'monospace';
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'üíæ Save';
            saveBtn.className = 'action-btn';
            saveBtn.style.marginTop = '10px';
            saveBtn.onclick = () => {
                content.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit;">${textarea.value}</pre>`;
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '‚ùå Cancel';
            cancelBtn.className = 'action-btn';
            cancelBtn.style.marginTop = '10px';
            cancelBtn.style.marginLeft = '10px';
            cancelBtn.onclick = () => {
                content.innerHTML = currentHtml;
            };
            
            content.innerHTML = '';
            content.appendChild(textarea);
            content.appendChild(saveBtn);
            content.appendChild(cancelBtn);
            textarea.focus();
        }
    };

    window.regenerateSchedule = async (messageId, prompt) => {
        const content = document.getElementById(`schedule-content-${messageId}`);
        if (content) {
            content.innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ Regenerating schedule...</div>';
            
            try {
                const schedulePrompt = `Create a different detailed schedule/routine table for: "${prompt}". Format as HTML table with proper styling. Include time slots, activities, and brief descriptions. Make it practical and well-organized. Create a variation from previous versions.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: schedulePrompt, history: [] })
                });
                
                const data = await response.json();
                content.innerHTML = data.text;
                
            } catch (error) {
                content.innerHTML = `<p style="color: var(--red-neon);">Failed to regenerate: ${error.message}</p>`;
            }
        }
    };

    const handleWhiteboardCommand = async (topic) => {
        const messageId = `whiteboard-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        
        const whiteboardHtml = `<div class="whiteboard-container" id="whiteboard-${messageId}">
            <div class="whiteboard-header">
                <h3>üìã Advanced Whiteboard</h3>
                <div class="whiteboard-controls">
                    <button class="action-btn" onclick="showColorPicker('${messageId}')">üé® Colors</button>
                    <button class="action-btn" onclick="undoBoard('${messageId}')">‚Ü∂ Undo</button>
                    <button class="action-btn" onclick="clearBoard('${messageId}')">üßπ Clear</button>
                    <button class="action-btn" onclick="saveBoard('${messageId}')">üíæ Save</button>
                </div>
            </div>
            <div class="whiteboard-canvas" id="canvas-${messageId}" style="background: #2d1b69; border-radius: 8px; position: relative; height: 500px; overflow: hidden;">
                <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.9); padding: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 6px; z-index: 100; max-width: 350px;">
                    <button onclick="setDrawTool('${messageId}', 'pen')" id="pen-${messageId}" style="background: #7a2bff; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">‚úèÔ∏è Pen</button>
                    <button onclick="setDrawTool('${messageId}', 'eraser')" id="eraser-${messageId}" style="background: #f44336; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">üßπ Erase</button>
                    <button onclick="setDrawTool('${messageId}', 'rectangle')" style="background: #4caf50; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">‚¨ú Rect</button>
                    <button onclick="setDrawTool('${messageId}', 'circle')" style="background: #2196f3; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">‚≠ï Circle</button>
                    <button onclick="setDrawTool('${messageId}', 'line')" id="line-${messageId}" style="background: #ff9800; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">‚Äî Line</button>
                    <button onclick="setDrawTool('${messageId}', 'dotted')" style="background: #795548; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">‚ãØ Dotted</button>
                    <button onclick="setDrawTool('${messageId}', 'arrow')" style="background: #607d8b; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">‚û°Ô∏è Arrow</button>
                    <button onclick="showTextPanel('${messageId}')" style="background: #9c27b0; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">T Text</button>
                    <button onclick="addStickyNote('${messageId}')" style="background: #ffc107; color: black; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">üìù Note</button>
                    <input type="range" id="size-${messageId}" min="1" max="25" value="3" style="width: 80px;">
                    <span style="color: white; font-size: 12px;" id="size-label-${messageId}">3px</span>
                </div>
                
                <!-- Color Picker Panel -->
                <div id="color-panel-${messageId}" style="display: none; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 8px; z-index: 101;">
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 10px;">
                        <div onclick="selectColor('${messageId}', '#ffffff')" style="width: 30px; height: 30px; background: #ffffff; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#000000')" style="width: 30px; height: 30px; background: #000000; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#ff0000')" style="width: 30px; height: 30px; background: #ff0000; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#00ff00')" style="width: 30px; height: 30px; background: #00ff00; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#0000ff')" style="width: 30px; height: 30px; background: #0000ff; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#ffff00')" style="width: 30px; height: 30px; background: #ffff00; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#ff00ff')" style="width: 30px; height: 30px; background: #ff00ff; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#00ffff')" style="width: 30px; height: 30px; background: #00ffff; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#ffa500')" style="width: 30px; height: 30px; background: #ffa500; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#800080')" style="width: 30px; height: 30px; background: #800080; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#008000')" style="width: 30px; height: 30px; background: #008000; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                        <div onclick="selectColor('${messageId}', '#ffc0cb')" style="width: 30px; height: 30px; background: #ffc0cb; border-radius: 4px; cursor: pointer; border: 2px solid #666;"></div>
                    </div>
                    <input type="color" id="custom-color-${messageId}" value="#ffffff" style="width: 100%; height: 35px; border: none; border-radius: 4px; cursor: pointer;">
                    <button onclick="hideColorPicker('${messageId}')" style="width: 100%; margin-top: 8px; background: #666; color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
                
                <!-- Text Input Panel -->
                <div id="text-panel-${messageId}" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 20px; border-radius: 8px; z-index: 102; min-width: 300px;">
                    <h4 style="color: white; margin: 0 0 10px 0;">Add Text</h4>
                    <input type="text" id="text-input-${messageId}" placeholder="Enter text..." style="width: 100%; padding: 8px; border: 1px solid #666; border-radius: 4px; background: #333; color: white; margin-bottom: 10px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="confirmText('${messageId}')" style="flex: 1; background: #4caf50; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">Add</button>
                        <button onclick="hideTextPanel('${messageId}')" style="flex: 1; background: #666; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
                
                <canvas id="draw-canvas-${messageId}" style="width: 100%; height: 100%; cursor: crosshair; display: block;"></canvas>
            </div>
        </div>`;
        
        currentChat.messages.push({ id: messageId, role: 'bot', text: whiteboardHtml, replyContext: '/whiteboard' });
        renderChatContent();
        saveChats();
        
        // Initialize canvas after rendering
        setTimeout(() => initCanvas(messageId), 100);
    };

    // Simple whiteboard implementation
    let canvases = {};
    
    const initCanvas = (messageId) => {
        const canvas = document.getElementById(`draw-canvas-${messageId}`);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        canvases[messageId] = {
            canvas,
            ctx,
            isDrawing: false,
            tool: 'pen',
            color: '#ffffff',
            size: 3,
            startX: 0,
            startY: 0,
            isShape: false,
            history: [],
            historyStep: -1,
            stickyNotes: []
        };
        
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 3;
        ctx.strokeStyle = '#ffffff';
        
        // Mouse events
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const tool = canvases[messageId].tool;
            
            if (['rectangle', 'circle', 'line', 'dotted', 'arrow'].includes(tool)) {
                canvases[messageId].isShape = true;
                canvases[messageId].startX = x;
                canvases[messageId].startY = y;
            } else {
                canvases[messageId].isDrawing = true;
                canvases[messageId].lastX = x;
                canvases[messageId].lastY = y;
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!canvases[messageId].isDrawing && !canvases[messageId].isShape) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (canvases[messageId].isDrawing) {
                ctx.beginPath();
                ctx.moveTo(canvases[messageId].lastX, canvases[messageId].lastY);
                ctx.lineTo(x, y);
                
                if (canvases[messageId].tool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 20;
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.lineWidth = canvases[messageId].size;
                    ctx.strokeStyle = canvases[messageId].color;
                }
                
                ctx.stroke();
                canvases[messageId].lastX = x;
                canvases[messageId].lastY = y;
            }
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (canvases[messageId].isShape) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = canvases[messageId].color;
                ctx.lineWidth = canvases[messageId].size;
                
                const startX = canvases[messageId].startX;
                const startY = canvases[messageId].startY;
                
                ctx.beginPath();
                if (canvases[messageId].tool === 'rectangle') {
                    ctx.rect(startX, startY, x - startX, y - startY);
                } else if (canvases[messageId].tool === 'circle') {
                    const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                } else if (canvases[messageId].tool === 'line') {
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(x, y);
                } else if (canvases[messageId].tool === 'dotted') {
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(x, y);
                    ctx.setLineDash([]);
                } else if (canvases[messageId].tool === 'arrow') {
                    // Draw arrow line
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(x, y);
                    
                    // Draw arrowhead
                    const angle = Math.atan2(y - startY, x - startX);
                    const headlen = 15;
                    ctx.moveTo(x, y);
                    ctx.lineTo(x - headlen * Math.cos(angle - Math.PI / 6), y - headlen * Math.sin(angle - Math.PI / 6));
                    ctx.moveTo(x, y);
                    ctx.lineTo(x - headlen * Math.cos(angle + Math.PI / 6), y - headlen * Math.sin(angle + Math.PI / 6));
                }
                ctx.stroke();
                
                canvases[messageId].isShape = false;
                saveCanvasState(messageId);
            }
            if (canvases[messageId].isDrawing) {
                saveCanvasState(messageId);
            }
            canvases[messageId].isDrawing = false;
        });
        
        canvas.addEventListener('mouseout', () => {
            canvases[messageId].isDrawing = false;
        });
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            canvases[messageId].isDrawing = true;
            canvases[messageId].lastX = x;
            canvases[messageId].lastY = y;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!canvases[messageId].isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(canvases[messageId].lastX, canvases[messageId].lastY);
            ctx.lineTo(x, y);
            
            if (canvases[messageId].tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 20;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineWidth = canvases[messageId].size;
                ctx.strokeStyle = canvases[messageId].color;
            }
            
            ctx.stroke();
            canvases[messageId].lastX = x;
            canvases[messageId].lastY = y;
        });
        
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            canvases[messageId].isDrawing = false;
        });
        
        // Tool controls
        const colorPicker = document.getElementById(`color-${messageId}`);
        const sizePicker = document.getElementById(`size-${messageId}`);
        
        if (colorPicker) {
            colorPicker.addEventListener('change', (e) => {
                canvases[messageId].color = e.target.value;
            });
        }
        
        if (sizePicker) {
            sizePicker.addEventListener('input', (e) => {
                canvases[messageId].size = e.target.value;
                const label = document.getElementById(`size-label-${messageId}`);
                if (label) label.textContent = e.target.value + 'px';
            });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undoBoard(messageId);
            }
        });
        
        // Save initial state
        saveCanvasState(messageId);
    };
    
    window.setDrawTool = (messageId, tool) => {
        if (canvases[messageId]) {
            canvases[messageId].tool = tool;
            const canvas = canvases[messageId].canvas;
            
            // Update cursor based on tool
            if (tool === 'eraser') {
                canvas.style.cursor = 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\'%3E%3Cpath fill=\'%23ff0000\' d=\'M16.24 3.56l4.95 4.94c.78.79.78 2.05 0 2.84L12 20.53a4.008 4.008 0 0 1-5.66 0L2.81 17c-.78-.79-.78-2.05 0-2.84l8.48-8.48c.79-.78 2.05-.78 2.84 0l2.11 2.12zm-1.41 1.41L12 2.15 3.52 10.63 8.37 15.48l8.48-8.48-1.41-1.41z\'/%3E%3C/svg%3E") 12 12, auto';
            } else {
                canvas.style.cursor = 'crosshair';
            }
        }
    };
    
    window.clearBoard = (messageId) => {
        if (canvases[messageId] && confirm('Clear whiteboard?')) {
            const ctx = canvases[messageId].ctx;
            ctx.clearRect(0, 0, canvases[messageId].canvas.width, canvases[messageId].canvas.height);
        }
    };
    
    window.showTextPanel = (messageId) => {
        document.getElementById(`text-panel-${messageId}`).style.display = 'block';
        document.getElementById(`text-input-${messageId}`).focus();
    };
    
    window.hideTextPanel = (messageId) => {
        document.getElementById(`text-panel-${messageId}`).style.display = 'none';
        document.getElementById(`text-input-${messageId}`).value = '';
    };
    
    window.confirmText = (messageId) => {
        const text = document.getElementById(`text-input-${messageId}`).value;
        if (!text || !canvases[messageId]) return;
        
        hideTextPanel(messageId);
        const canvas = canvases[messageId].canvas;
        const ctx = canvases[messageId].ctx;
        
        const addTextAtClick = (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.font = '16px Arial';
            ctx.fillStyle = canvases[messageId].color;
            ctx.fillText(text, x, y);
            
            canvas.removeEventListener('click', addTextAtClick);
            canvas.style.cursor = 'crosshair';
            saveCanvasState(messageId);
        };
        
        canvas.style.cursor = 'text';
        canvas.addEventListener('click', addTextAtClick);
    };
    
    window.showColorPicker = (messageId) => {
        document.getElementById(`color-panel-${messageId}`).style.display = 'block';
    };
    
    window.hideColorPicker = (messageId) => {
        document.getElementById(`color-panel-${messageId}`).style.display = 'none';
    };
    
    window.selectColor = (messageId, color) => {
        if (canvases[messageId]) {
            canvases[messageId].color = color;
        }
    };
    
    window.addStickyNote = (messageId) => {
        if (!canvases[messageId]) return;
        
        const colors = ['#ffeb3b', '#4caf50', '#2196f3', '#ff9800', '#e91e63', '#9c27b0'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        const note = {
            id: Date.now(),
            x: 200 + Math.random() * 200,
            y: 150 + Math.random() * 200,
            width: 150,
            height: 100,
            color: color,
            text: 'Double-click to edit'
        };
        
        canvases[messageId].stickyNotes.push(note);
        renderStickyNote(messageId, note);
    };
    
    const renderStickyNote = (messageId, note) => {
        const canvas = document.getElementById(`canvas-${messageId}`);
        const noteEl = document.createElement('div');
        noteEl.style.cssText = `position: absolute; left: ${note.x}px; top: ${note.y}px; width: ${note.width}px; height: ${note.height}px; background: ${note.color}; border-radius: 8px; padding: 8px; font-size: 12px; cursor: move; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 50; border: 2px solid rgba(0,0,0,0.1);`;
        
        noteEl.innerHTML = `<div contenteditable="true" style="width: 100%; height: 100%; outline: none; overflow: hidden; color: #000;">${note.text}</div>`;
        
        canvas.appendChild(noteEl);
        
        // Make draggable
        let isDragging = false;
        let startX, startY;
        
        noteEl.addEventListener('mousedown', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true') return;
            e.preventDefault();
            isDragging = true;
            startX = e.clientX - note.x;
            startY = e.clientY - note.y;
            noteEl.style.zIndex = '100';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            note.x = e.clientX - startX;
            note.y = e.clientY - startY;
            noteEl.style.left = note.x + 'px';
            noteEl.style.top = note.y + 'px';
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                noteEl.style.zIndex = '50';
            }
        });
        
        // Update text on edit
        const textEl = noteEl.querySelector('[contenteditable]');
        textEl.addEventListener('blur', () => {
            note.text = textEl.textContent;
        });
    };
    
    const saveCanvasState = (messageId) => {
        if (!canvases[messageId]) return;
        
        const canvas = canvases[messageId];
        canvas.historyStep++;
        if (canvas.historyStep < canvas.history.length) {
            canvas.history.length = canvas.historyStep;
        }
        canvas.history.push(canvas.canvas.toDataURL());
        
        if (canvas.history.length > 20) {
            canvas.history.shift();
            canvas.historyStep--;
        }
    };
    
    window.undoBoard = (messageId) => {
        if (!canvases[messageId] || canvases[messageId].historyStep <= 0) return;
        
        canvases[messageId].historyStep--;
        const img = new Image();
        img.onload = () => {
            const ctx = canvases[messageId].ctx;
            ctx.clearRect(0, 0, canvases[messageId].canvas.width, canvases[messageId].canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = canvases[messageId].history[canvases[messageId].historyStep];
    };
    
    window.saveBoard = (messageId) => {
        if (!canvases[messageId]) return;
        
        const canvas = canvases[messageId].canvas;
        const link = document.createElement('a');
        link.download = `whiteboard-${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    };
    
    const handleRecipeCommand = async (ingredients) => {
        const messageId = `recipe-${Date.now()}`;
        const currentChat = chats.find(c => c.id === activeChatId);
        if(!currentChat) return;
        
        // If ingredients are provided directly, generate recipe immediately
        if (ingredients && ingredients.trim()) {
            currentChat.messages.push({ id: messageId, role: 'bot', text: 'Generating recipe with your ingredients...', replyContext: '/recipe' });
            renderChatContent();
            
            const recipePrompt = `Write a recipe using these ingredients: ${ingredients}. Format as HTML with h2 for title, table for ingredients, and numbered list for steps.`;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: recipePrompt, history: [], tools: [] })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Failed to generate recipe');
                }
                
                const data = await response.json();
                let recipeText = data.text;
                if (recipeText.includes('tool_call') || recipeText.includes('generate_recipe')) {
                    recipeText = 'Recipe generation failed. Please try again.';
                }
                
                const recipeHtml = `<div class="recipe-result">
                    <div class="recipe-header">
                        <h3>üç≥ Your Recipe</h3>
                    </div>
                    <div class="recipe-content">
                        ${recipeText}
                    </div>
                </div>`;
                
                const msg = currentChat.messages.find(m => m.id === messageId);
                if (msg) {
                    msg.text = recipeHtml;
                }
                
                renderChatContent();
                saveChats();
                
            } catch (error) {
                console.error('Recipe generation error:', error);
                const msg = currentChat.messages.find(m => m.id === messageId);
                if (msg) {
                    msg.text = `<div style="color: var(--red-neon); text-align: center; padding: 20px;">Sorry, couldn't generate the recipe. ${error.message}</div>`;
                }
                renderChatContent();
            }
            return;
        }
        
        // Show recipe generator interface
        const recipeHtml = `<div class="recipe-container" id="recipe-${messageId}">
            <div class="recipe-header">
                <h3>üç≥ Recipe Generator</h3>
                <div class="diet-selector">
                    <button class="diet-btn active" id="both-${messageId}" onclick="selectDiet('${messageId}', 'both')">üçΩÔ∏è All</button>
                    <button class="diet-btn" id="veg-${messageId}" onclick="selectDiet('${messageId}', 'veg')">üå± Vegetarian</button>
                    <button class="diet-btn" id="nonveg-${messageId}" onclick="selectDiet('${messageId}', 'nonveg')">üçñ Non-Veg</button>
                    <button class="diet-btn" id="vegan-${messageId}" onclick="selectDiet('${messageId}', 'vegan')">ü•¨ Vegan</button>
                </div>
            </div>
            
            <div class="recipe-options">
                <div class="option-card" onclick="showIngredientPanel('${messageId}')">
                    <div class="option-icon">ü•ò</div>
                    <h4>I have ingredients</h4>
                    <p>Tell me what you have and I'll create magic!</p>
                </div>
                <div class="option-card" onclick="generateRandomRecipe('${messageId}')">
                    <div class="option-icon">üé≤</div>
                    <h4>Surprise me!</h4>
                    <p>Generate a random delicious recipe</p>
                </div>
                <div class="option-card" onclick="generateByMeal('${messageId}', 'breakfast')">
                    <div class="option-icon">üåÖ</div>
                    <h4>Breakfast Ideas</h4>
                    <p>Start your day with something amazing</p>
                </div>
                <div class="option-card" onclick="generateByMeal('${messageId}', 'lunch')">
                    <div class="option-icon">üåû</div>
                    <h4>Lunch Recipes</h4>
                    <p>Perfect midday meals</p>
                </div>
                <div class="option-card" onclick="generateByMeal('${messageId}', 'dinner')">
                    <div class="option-icon">üåô</div>
                    <h4>Dinner Delights</h4>
                    <p>End your day with a feast</p>
                </div>
                <div class="option-card" onclick="generateByMeal('${messageId}', 'dessert')">
                    <div class="option-icon">üç∞</div>
                    <h4>Sweet Treats</h4>
                    <p>Desserts to satisfy your cravings</p>
                </div>
                <div class="option-card" onclick="generateHealthyRecipe('${messageId}')">
                    <div class="option-icon">üí™</div>
                    <h4>Healthy & Fit</h4>
                    <p>Nutritious recipes for wellness</p>
                </div>
                <div class="option-card" onclick="generateQuickRecipe('${messageId}')">
                    <div class="option-icon">‚ö°</div>
                    <h4>Quick & Easy</h4>
                    <p>Ready in 15 minutes or less</p>
                </div>
            </div>
            
            <!-- Ingredient Selection Panel -->
            <div id="ingredient-panel-${messageId}" class="ingredient-panel" style="display: none;">
                <h4>ü•ò What ingredients do you have?</h4>
                <div class="quick-ingredients">
                    <button onclick="quickAddIngredient('${messageId}', 'chicken')" class="quick-ingredient-btn">üêî Chicken</button>
                    <button onclick="quickAddIngredient('${messageId}', 'beef')" class="quick-ingredient-btn">ü•© Beef</button>
                    <button onclick="quickAddIngredient('${messageId}', 'fish')" class="quick-ingredient-btn">üêü Fish</button>
                    <button onclick="quickAddIngredient('${messageId}', 'eggs')" class="quick-ingredient-btn">ü•ö Eggs</button>
                    <button onclick="quickAddIngredient('${messageId}', 'rice')" class="quick-ingredient-btn">üçö Rice</button>
                    <button onclick="quickAddIngredient('${messageId}', 'pasta')" class="quick-ingredient-btn">üçù Pasta</button>
                    <button onclick="quickAddIngredient('${messageId}', 'potatoes')" class="quick-ingredient-btn">ü•î Potatoes</button>
                    <button onclick="quickAddIngredient('${messageId}', 'tomatoes')" class="quick-ingredient-btn">üçÖ Tomatoes</button>
                    <button onclick="quickAddIngredient('${messageId}', 'onions')" class="quick-ingredient-btn">üßÖ Onions</button>
                    <button onclick="quickAddIngredient('${messageId}', 'garlic')" class="quick-ingredient-btn">üßÑ Garlic</button>
                    <button onclick="quickAddIngredient('${messageId}', 'corn')" class="quick-ingredient-btn">üåΩ Corn</button>
                    <button onclick="quickAddIngredient('${messageId}', 'carrots')" class="quick-ingredient-btn">ü•ï Carrots</button>
                    <button onclick="quickAddIngredient('${messageId}', 'spinach')" class="quick-ingredient-btn">ü•¨ Spinach</button>
                    <button onclick="quickAddIngredient('${messageId}', 'mushrooms')" class="quick-ingredient-btn">üçÑ Mushrooms</button>
                    <button onclick="quickAddIngredient('${messageId}', 'ginger')" class="quick-ingredient-btn">ü¶® Ginger</button>
                    <button onclick="quickAddIngredient('${messageId}', 'turmeric')" class="quick-ingredient-btn">üü° Turmeric</button>
                    <button onclick="quickAddIngredient('${messageId}', 'cumin')" class="quick-ingredient-btn">üå∂Ô∏è Cumin</button>
                    <button onclick="quickAddIngredient('${messageId}', 'coriander')" class="quick-ingredient-btn">üåø Coriander</button>
                    <button onclick="quickAddIngredient('${messageId}', 'coconut')" class="quick-ingredient-btn">ü•• Coconut</button>
                    <button onclick="quickAddIngredient('${messageId}', 'lentils')" class="quick-ingredient-btn">ü•≠ Lentils</button>
                </div>
                <div class="ingredient-input-container">
                    <input type="text" id="ingredient-input-${messageId}" placeholder="Or type any ingredient..." autocomplete="off">
                    <button onclick="addIngredient('${messageId}')" class="add-btn">+ Add</button>
                </div>
                <div id="suggestions-${messageId}" class="suggestions"></div>
                <div id="selected-ingredients-${messageId}" class="selected-ingredients"></div>
                <div class="panel-actions">
                    <button onclick="findRecipes('${messageId}')" class="action-btn primary">üîç Find Recipes</button>
                    <button onclick="clearIngredients('${messageId}')" class="action-btn secondary">üóëÔ∏è Clear All</button>
                    <button onclick="hideIngredientPanel('${messageId}')" class="action-btn">‚ùå Cancel</button>
                </div>
            </div>
        </div>`;
        
        currentChat.messages.push({ id: messageId, role: 'bot', text: recipeHtml, replyContext: '/recipe' });
        renderChatContent();
        saveChats();
    };
    
    // Recipe ingredient suggestions database
    const ingredientSuggestions = [
        'chicken', 'beef', 'pork', 'fish', 'salmon', 'tuna', 'shrimp', 'eggs',
        'rice', 'pasta', 'bread', 'flour', 'potatoes', 'sweet potatoes',
        'tomatoes', 'onions', 'garlic', 'ginger', 'carrots', 'bell peppers',
        'spinach', 'broccoli', 'mushrooms', 'zucchini', 'eggplant', 'cucumber',
        'cheese', 'milk', 'butter', 'yogurt', 'cream', 'mozzarella', 'parmesan',
        'olive oil', 'coconut oil', 'soy sauce', 'vinegar', 'lemon', 'lime',
        'basil', 'oregano', 'thyme', 'rosemary', 'cilantro', 'parsley',
        'salt', 'pepper', 'paprika', 'cumin', 'turmeric', 'chili powder',
        'corn', 'peas', 'beans', 'lentils', 'chickpeas', 'paneer', 'tofu',
        'cardamom', 'cinnamon', 'cloves', 'bay leaves', 'mustard seeds',
        'fenugreek', 'asafoetida', 'curry leaves', 'coconut', 'cashews',
        'almonds', 'basmati rice', 'ghee', 'tamarind', 'jaggery'
    ];
    
    let selectedIngredients = {};
    let currentDiet = {};
    
    window.selectDiet = (messageId, diet) => {
        currentDiet[messageId] = diet;
        ['both', 'veg', 'nonveg', 'vegan'].forEach(d => {
            const btn = document.getElementById(`${d}-${messageId}`);
            if (btn) btn.classList.remove('active');
        });
        const activeBtn = document.getElementById(`${diet}-${messageId}`);
        if (activeBtn) activeBtn.classList.add('active');
    };
    
    window.showIngredientPanel = (messageId) => {
        const panel = document.getElementById(`ingredient-panel-${messageId}`);
        if (panel) {
            panel.style.display = 'block';
            selectedIngredients[messageId] = [];
            currentDiet[messageId] = currentDiet[messageId] || 'both';
            
            const input = document.getElementById(`ingredient-input-${messageId}`);
            if (input) {
                input.focus();
                
                // Add input event listener for suggestions
                input.addEventListener('input', (e) => {
                    showSuggestions(messageId, e.target.value);
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addIngredient(messageId);
                    }
                });
            }
        }
    };
    
    window.hideIngredientPanel = (messageId) => {
        const panel = document.getElementById(`ingredient-panel-${messageId}`);
        if (panel) panel.style.display = 'none';
    };
    
    const showSuggestions = (messageId, query) => {
        const suggestionsDiv = document.getElementById(`suggestions-${messageId}`);
        if (!suggestionsDiv) return;
        
        if (query.length < 2) {
            suggestionsDiv.innerHTML = '';
            return;
        }
        
        const matches = ingredientSuggestions.filter(ingredient => 
            ingredient.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 5);
        
        suggestionsDiv.innerHTML = matches.map(ingredient => 
            `<div class="suggestion-item" onclick="selectSuggestion('${messageId}', '${ingredient}')">${ingredient}</div>`
        ).join('');
    };
    
    window.selectSuggestion = (messageId, ingredient) => {
        const input = document.getElementById(`ingredient-input-${messageId}`);
        const suggestions = document.getElementById(`suggestions-${messageId}`);
        if (input) input.value = ingredient;
        if (suggestions) suggestions.innerHTML = '';
        addIngredient(messageId);
    };
    
    window.addIngredient = (messageId) => {
        const input = document.getElementById(`ingredient-input-${messageId}`);
        if (!input) return;
        
        const ingredient = input.value.trim();
        
        if (ingredient && (!selectedIngredients[messageId] || !selectedIngredients[messageId].includes(ingredient))) {
            if (!selectedIngredients[messageId]) selectedIngredients[messageId] = [];
            selectedIngredients[messageId].push(ingredient);
            updateSelectedIngredients(messageId);
            input.value = '';
            const suggestions = document.getElementById(`suggestions-${messageId}`);
            if (suggestions) suggestions.innerHTML = '';
        }
    };
    
    const updateSelectedIngredients = (messageId) => {
        const container = document.getElementById(`selected-ingredients-${messageId}`);
        if (!container || !selectedIngredients[messageId]) return;
        
        container.innerHTML = selectedIngredients[messageId].map(ingredient => 
            `<span class="ingredient-tag">${ingredient} <button onclick="removeIngredient('${messageId}', '${ingredient}')">√ó</button></span>`
        ).join('');
    };
    
    window.removeIngredient = (messageId, ingredient) => {
        if (selectedIngredients[messageId]) {
            selectedIngredients[messageId] = selectedIngredients[messageId].filter(i => i !== ingredient);
            updateSelectedIngredients(messageId);
        }
    };
    
    window.findRecipes = async (messageId) => {
        if (!selectedIngredients[messageId] || selectedIngredients[messageId].length === 0) {
            alert('Please add at least one ingredient!');
            return;
        }
        
        const diet = currentDiet[messageId] || 'both';
        const ingredients = selectedIngredients[messageId].join(', ');
        
        hideIngredientPanel(messageId);
        
        const dietText = diet === 'both' ? '' : diet === 'veg' ? 'vegetarian' : 'non-vegetarian';
        const recipePrompt = `You are a chef. Do not use function calls. Create a detailed ${dietText} recipe using these ingredients: ${ingredients}. Include:
        1. Recipe name and description
        2. Ingredients table with quantities (use HTML table format)
        3. Nutrition information (calories, protein, carbs, fat per serving)
        4. Step-by-step cooking instructions (numbered list)
        5. Cooking time, prep time, and servings
        Format as HTML with proper styling. Make it look professional and appetizing.`;
        
        await generateRecipeFromPrompt(messageId, recipePrompt);
    };
    
    window.generateRandomRecipe = async (messageId) => {
        const diet = currentDiet[messageId] || 'both';
        
        const recipePrompt = `Generate a ${diet === 'both' ? '' : diet} recipe. Format as HTML with h2 title, ingredient table, numbered steps.`;
        
        const container = document.getElementById(`recipe-${messageId}`);
        if (container) {
            container.innerHTML = '<div class="loading-text">üç≥ Generating recipe...</div>';
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: recipePrompt, history: [], tools: [] })
                });
                const data = await response.json();
                let recipeText = data.text.replace(/Calories:/g, 'üî• Calories:').replace(/Protein:/g, 'üí™ Protein:').replace(/Carbs:/g, 'üçû Carbs:').replace(/Fat:/g, 'üßà Fat:').replace(/Prep Time:/g, '‚è±Ô∏è Prep Time:').replace(/Cook Time:/g, 'üî• Cook Time:').replace(/Servings:/g, 'üçΩÔ∏è Servings:');
                container.innerHTML = `<div class="recipe-result"><div class="recipe-content">${recipeText}</div></div>`;
            } catch (error) {
                container.innerHTML = `<div style="color: var(--red-neon); padding: 20px;">Error: ${error.message}</div>`;
            }
        }
        
        await generateRecipeFromPrompt(messageId, recipePrompt);
    };
    
    window.generateByMeal = async (messageId, mealType) => {
        const diet = currentDiet[messageId] || 'both';
        const dietText = diet === 'both' ? '' : diet === 'veg' ? 'vegetarian' : diet === 'vegan' ? 'vegan' : 'non-vegetarian';
        
        const recipePrompt = `You are a chef. Do not use function calls. Generate a delicious ${dietText} ${mealType} recipe. Make it perfect for ${mealType} time. Include complete ingredients table, nutrition info, and detailed cooking instructions.`;
        
        await generateRecipeFromPrompt(messageId, recipePrompt);
    };
    
    window.generateHealthyRecipe = async (messageId) => {
        const diet = currentDiet[messageId] || 'both';
        const dietText = diet === 'both' ? '' : diet === 'veg' ? 'vegetarian' : diet === 'vegan' ? 'vegan' : 'non-vegetarian';
        
        const recipePrompt = `You are a chef. Do not use function calls. Generate a healthy, nutritious ${dietText} recipe that's low in calories but high in protein and nutrients. Perfect for fitness enthusiasts. Include complete nutritional breakdown.`;
        
        await generateRecipeFromPrompt(messageId, recipePrompt);
    };
    
    window.generateQuickRecipe = async (messageId) => {
        const diet = currentDiet[messageId] || 'both';
        const dietText = diet === 'both' ? '' : diet === 'veg' ? 'vegetarian' : diet === 'vegan' ? 'vegan' : 'non-vegetarian';
        
        const recipePrompt = `You are a chef. Do not use function calls. Generate a quick and easy ${dietText} recipe that can be made in 15 minutes or less. Perfect for busy people. Include prep and cooking time breakdown.`;
        
        await generateRecipeFromPrompt(messageId, recipePrompt);
    };
    
    window.quickAddIngredient = (messageId, ingredient) => {
        if (!selectedIngredients[messageId]) selectedIngredients[messageId] = [];
        if (!selectedIngredients[messageId].includes(ingredient)) {
            selectedIngredients[messageId].push(ingredient);
            updateSelectedIngredients(messageId);
        }
    };
    
    window.clearIngredients = (messageId) => {
        selectedIngredients[messageId] = [];
        updateSelectedIngredients(messageId);
    };
    
    window.copyRecipe = async (messageId) => {
        const content = document.getElementById(`recipe-content-${messageId}`);
        if (content) {
            try {
                await navigator.clipboard.writeText(content.innerText);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = 'var(--green-neon)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('Failed to copy recipe');
            }
        }
    };
    
    window.shareRecipe = (messageId) => {
        const content = document.getElementById(`recipe-content-${messageId}`);
        if (content && navigator.share) {
            navigator.share({
                title: 'Check out this recipe!',
                text: content.innerText
            });
        } else {
            copyRecipe(messageId);
        }
    };
    
    window.generateAnother = (messageId) => {
        generateRandomRecipe(messageId);
    };
    
    const generateRecipeFromPrompt = async (messageId, prompt) => {
        const container = document.getElementById(`recipe-${messageId}`);
        if (!container) return;
        
        container.innerHTML = `<div style="text-align: center; padding: 40px;">
            <div class="loading-text">üç≥ Cooking up something delicious...</div>
            <div style="margin-top: 20px; font-size: 14px; color: #ccc;">This might take a moment</div>
        </div>`;
        
        try {
            const enhancedPrompt = `${prompt} Format as HTML with h2 title, ingredient table, numbered steps.`;
            
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: enhancedPrompt, history: [], tools: [] })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Failed to generate recipe');
            }
            
            const data = await response.json();
            let recipeText = data.text;
            if (recipeText.includes('tool_call') || recipeText.includes('generate_recipe')) {
                recipeText = 'Recipe generation failed. Please try again.';
            }
            
            const recipeHtml = `<div class="recipe-result">
                <div class="recipe-header">
                    <h3>üç≥ Your Recipe is Ready!</h3>
                    <div class="recipe-actions">
                        <button onclick="copyRecipe('${messageId}')" class="action-btn">üìã Copy</button>
                        <button onclick="shareRecipe('${messageId}')" class="action-btn">üì§ Share</button>
                        <button onclick="generateAnother('${messageId}')" class="action-btn primary">üé≤ Another Recipe</button>
                    </div>
                </div>
                <div class="recipe-content" id="recipe-content-${messageId}">
                    ${recipeText}
                </div>
            </div>`;
            
            const currentChat = chats.find(c => c.id === activeChatId);
            const msg = currentChat?.messages.find(m => m.id === messageId);
            if (msg) {
                msg.text = recipeHtml;
                msg.replyContext = '/recipe';
            }
            
            container.innerHTML = recipeHtml;
            saveChats();
            
        } catch (error) {
            console.error('Recipe generation error:', error);
            container.innerHTML = `<div style="color: var(--red-neon); text-align: center; padding: 20px;">
                <h4>üòî Oops! Something went wrong</h4>
                <p>Couldn't generate the recipe: ${error.message}</p>
                <button onclick="location.reload()" class="action-btn">üîÑ Try Again</button>
            </div>`;
        }
    };

    window.revokeAccess = (username) => {
        if (confirm(`Are you sure you want to revoke access for ${username}?`)) {
            alert(`Access revoked for ${username}`);
            // In a real implementation, this would make an API call
        }
    };
    
    window.approveRequest = (requestId) => {
        if (confirm('Approve this access request?')) {
            let adminRequests = JSON.parse(localStorage.getItem('seasworth_admin_requests') || '[]');
            const requestIndex = adminRequests.findIndex(req => req.id === requestId);
            
            if (requestIndex > -1) {
                adminRequests[requestIndex].status = 'approved';
                adminRequests[requestIndex].approvedBy = currentUser;
                adminRequests[requestIndex].approvedAt = new Date().toLocaleString();
                
                localStorage.setItem('seasworth_admin_requests', JSON.stringify(adminRequests));
                
                alert('‚úÖ Access request approved! User will be notified.');
                showDevPortal(); // Refresh the view
            }
        }
    };
    
    window.rejectRequest = (requestId) => {
        if (confirm('Reject this access request?')) {
            let adminRequests = JSON.parse(localStorage.getItem('seasworth_admin_requests') || '[]');
            const requestIndex = adminRequests.findIndex(req => req.id === requestId);
            
            if (requestIndex > -1) {
                adminRequests[requestIndex].status = 'rejected';
                adminRequests[requestIndex].rejectedBy = currentUser;
                adminRequests[requestIndex].rejectedAt = new Date().toLocaleString();
                
                localStorage.setItem('seasworth_admin_requests', JSON.stringify(adminRequests));
                
                alert('‚ùå Access request rejected.');
                showDevPortal(); // Refresh the view
            }
        }
    };

    window.showDevPortal = () => {
        const adminRequests = JSON.parse(localStorage.getItem('seasworth_admin_requests') || '[]');
        const pendingRequests = adminRequests.filter(req => req.status === 'pending');
        
        let requestsHtml = '';
        if (pendingRequests.length > 0) {
            requestsHtml = `<div id="access-content" style="display: none;">
                <h3>üé´ Pending Access Requests (${pendingRequests.length})</h3>
                <div style="background: rgba(255,215,0,0.1); border: 1px solid #ffd700; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">‚ö†Ô∏è New Requests Awaiting Review</h4>`;
            
            pendingRequests.forEach(req => {
                requestsHtml += `<div style="background: rgba(0,0,0,0.3); padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 3px solid #ffd700;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong style="color: #fff;">${req.fullName}</strong> <span style="color: #ccc;">(${req.email})</span><br>
                            <small style="color: #aaa;">Duration: ${req.duration} days | Submitted: ${req.submittedAt}</small><br>
                            <small style="color: #888;">Ticket ID: ${req.id}</small>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="approveRequest('${req.id}')" style="background: var(--green-neon); color: #000; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úÖ Accept</button>
                            <button onclick="rejectRequest('${req.id}')" style="background: var(--red-neon); color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚ùå Revoke</button>
                        </div>
                    </div>
                </div>`;
            });
            requestsHtml += `</div></div>`;
        } else {
            requestsHtml = `<div id="access-content" style="display: none;">
                <h3>üé´ Access Requests</h3>
                <div style="background: rgba(0,255,106,0.1); border: 1px solid var(--green-neon); border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <p style="color: var(--green-neon); margin: 0;">‚úÖ No pending requests</p>
                </div>
            </div>`;
        }
        
        const content = `<div class="study-guide-container">
            <h2>‚öôÔ∏è Developer Portal</h2>
            <p><strong>Access Level:</strong> ${isAdmin ? 'Administrator' : 'Standard'} | <strong>User:</strong> ${currentUser}</p>
            
            <div style="background: rgba(122,43,255,0.1); border: 1px solid var(--accent1); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--neon); margin-bottom: 15px;">üë®‚Äçüíª Devs</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="toggleDevSection('access')" id="access-btn" style="background: var(--accent1); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">üîë Access</button>
                    <button onclick="toggleDevSection('support')" id="support-btn" style="background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">üéÜ Support</button>
                </div>
                
                ${requestsHtml}
                
                <div id="support-content" style="display: none;">
                    <h3>üéÜ Support Tickets</h3>
                    <div id="support-tickets-list">
                        <!-- Support tickets will be loaded here -->
                    </div>
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 20px; margin-top: 20px;">
                        <h4 style="color: var(--neon); margin-bottom: 15px;">üìß Contact Information</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <strong>Email:</strong> support@seasworth.ai<br>
                                <strong>Response Time:</strong> 2-4 hours<br>
                                <strong>Priority:</strong> High
                            </div>
                            <div>
                                <strong>Discord:</strong> seasworth#7878<br>
                                <strong>Telegram:</strong> @seasworthAI<br>
                                <strong>Status:</strong> <span style="color: var(--green-neon);">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h3>üë• User Management</h3>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: var(--accent1);">
                        <th style="padding: 12px; color: white; font-weight: 600;">Username</th>
                        <th style="padding: 12px; color: white; font-weight: 600;">Password</th>
                        <th style="padding: 12px; color: white; font-weight: 600;">Access Level</th>
                        <th style="padding: 12px; color: white; font-weight: 600;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">seasworthisthegoat</td>
                        <td style="padding: 12px; font-family: monospace;">#Flex7878</td>
                        <td style="padding: 12px; color: var(--green-neon);">Administrator</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('seasworthisthegoat')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">jif4848</td>
                        <td style="padding: 12px; font-family: monospace;">388483</td>
                        <td style="padding: 12px; color: var(--green-neon);">Administrator</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('jif4848')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">vn73k</td>
                        <td style="padding: 12px; font-family: monospace;">384729</td>
                        <td style="padding: 12px; color: var(--green-neon);">Administrator</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('vn73k')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">djalf48</td>
                        <td style="padding: 12px; font-family: monospace;">483982</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('djalf48')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">93skd4</td>
                        <td style="padding: 12px; font-family: monospace;">48934</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('93skd4')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">kx92m</td>
                        <td style="padding: 12px; font-family: monospace;">749382</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('kx92m')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">pq84j</td>
                        <td style="padding: 12px; font-family: monospace;">592847</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('pq84j')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">zr48x</td>
                        <td style="padding: 12px; font-family: monospace;">672948</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('zr48x')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">lm39d</td>
                        <td style="padding: 12px; font-family: monospace;">847293</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('lm39d')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">hf62s</td>
                        <td style="padding: 12px; font-family: monospace;">582947</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('hf62s')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">bt94k</td>
                        <td style="padding: 12px; font-family: monospace;">738294</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('bt94k')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">mx47p</td>
                        <td style="padding: 12px; font-family: monospace;">629384</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('mx47p')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">gy58w</td>
                        <td style="padding: 12px; font-family: monospace;">847392</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('gy58w')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">nk73q</td>
                        <td style="padding: 12px; font-family: monospace;">394728</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('nk73q')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">dk38r</td>
                        <td style="padding: 12px; font-family: monospace;">629473</td>
                        <td style="padding: 12px; color: #ccc;">Standard User</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('dk38r')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">zt91f</td>
                        <td style="padding: 12px; font-family: monospace;">384729</td>
                        <td style="padding: 12px; color: #888;">Guest (Limited)</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('zt91f')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                    <tr onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">qm56h</td>
                        <td style="padding: 12px; font-family: monospace;">927384</td>
                        <td style="padding: 12px; color: #888;">Guest (Limited)</td>
                        <td style="padding: 12px;"><button class="action-btn" onclick="revokeAccess('qm56h')" style="background: var(--red-neon); border: none; padding: 4px 8px; font-size: 12px;">Revoke</button></td>
                    </tr>
                </tbody>
            </table>
            
            <h3>üîå API Usage & Limits</h3>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: var(--accent1);">
                        <th style="padding: 12px; color: white; font-weight: 600;">API Service</th>
                        <th style="padding: 12px; color: white; font-weight: 600;">Points Remaining</th>
                        <th style="padding: 12px; color: white; font-weight: 600;">Daily Limit</th>
                        <th style="padding: 12px; color: white; font-weight: 600;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">Groq AI Chat</td>
                        <td style="padding: 12px; color: var(--green-neon);">8,547</td>
                        <td style="padding: 12px;">10,000</td>
                        <td style="padding: 12px; color: var(--green-neon);">Active</td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">ClipDrop Image Gen</td>
                        <td style="padding: 12px; color: #ffc107;">234</td>
                        <td style="padding: 12px;">500</td>
                        <td style="padding: 12px; color: #ffc107;">Limited</td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">CoinGecko API</td>
                        <td style="padding: 12px; color: var(--green-neon);">9,876</td>
                        <td style="padding: 12px;">10,000</td>
                        <td style="padding: 12px; color: var(--green-neon);">Active</td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">Web Search API</td>
                        <td style="padding: 12px; color: var(--red-neon);">12</td>
                        <td style="padding: 12px;">1,000</td>
                        <td style="padding: 12px; color: var(--red-neon);">Critical</td>
                    </tr>
                    <tr onmouseover="this.style.background='rgba(122,43,255,0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px;">Miro Web SDK</td>
                        <td style="padding: 12px; color: var(--green-neon);">Unlimited</td>
                        <td style="padding: 12px;">Connected</td>
                        <td style="padding: 12px; color: var(--green-neon);">Active</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>üîë API Key Management</h3>
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <button onclick="generateApiKey()" style="background: var(--accent1); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Generate New API Key</button>
                <div id="apiKeyDisplay" style="display: none; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; font-family: monospace; word-break: break-all;"></div>
            </div>
            
                <h3>System Information</h3>
                <ul>
                    <li><strong>Access ID:</strong> DEV-${Date.now().toString(36).toUpperCase()}</li>
                    <li><strong>Build Version:</strong> v1.2.0-dev</li>
                    <li><strong>API Endpoint:</strong> /api/chat</li>
                    <li><strong>Miro Client ID:</strong> 3458764637291512721</li>
                    <li><strong>Miro Integration:</strong> Enabled</li>
                    <li><strong>Zoom SDK:</strong> Available</li>
                    <li><strong>Whiteboard APIs:</strong> Multiple Options</li>
                </ul>
            </div>`;
        
        // Set active state and show access & support portal
        document.querySelector('.footer-tab[onclick="showAbout()"]').classList.remove('active');
        document.querySelector('.footer-tab[onclick="showHelp()"]').classList.remove('active');
        document.querySelector('.footer-tab[onclick="showDevPortal()"]').classList.add('active');
        document.querySelector('.composer').style.display = 'none';
        welcomeScreen.style.display = 'none';
        messageArea.style.display = 'flex';
        messageArea.innerHTML = `<div class="message-bubble bot-message"><div class="icon"><div class="status-orb"><div class="orb-core"></div><div class="orb-dot"></div><div class="orb-dot"></div><div class="orb-dot"></div></div></div><div class="message-content">${content}</div></div>`;
        activeChatId = 'access-support';
        renderChatList();
    };



    window.toggleDevSection = (section) => {
        const accessContent = document.getElementById('access-content');
        const supportContent = document.getElementById('support-content');
        const accessBtn = document.getElementById('access-btn');
        const supportBtn = document.getElementById('support-btn');
        
        if (section === 'access') {
            accessContent.style.display = 'block';
            supportContent.style.display = 'none';
            accessBtn.style.background = 'var(--accent1)';
            accessBtn.style.color = 'white';
            supportBtn.style.background = 'rgba(255,255,255,0.1)';
            supportBtn.style.color = '#ccc';
        } else {
            accessContent.style.display = 'none';
            supportContent.style.display = 'block';
            supportBtn.style.background = 'var(--accent1)';
            supportBtn.style.color = 'white';
            accessBtn.style.background = 'rgba(255,255,255,0.1)';
            accessBtn.style.color = '#ccc';
            loadSupportTickets();
        }
    };
    
    const loadSupportTickets = () => {
        const supportTickets = JSON.parse(localStorage.getItem('seasworth_support_tickets') || '[]');
        const ticketsList = document.getElementById('support-tickets-list');
        
        if (supportTickets.length === 0) {
            ticketsList.innerHTML = `<div style="background: rgba(0,255,106,0.1); border: 1px solid var(--green-neon); border-radius: 8px; padding: 15px; text-align: center;">
                <p style="color: var(--green-neon); margin: 0;">‚úÖ No support tickets</p>
            </div>`;
            return;
        }
        
        let ticketsHtml = `<div style="background: rgba(255,215,0,0.1); border: 1px solid #ffd700; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #ffd700; margin-bottom: 15px;">‚ö†Ô∏è Support Tickets (${supportTickets.length})</h4>`;
        
        supportTickets.forEach(ticket => {
            ticketsHtml += `<div style="background: rgba(0,0,0,0.3); padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 3px solid #ffd700;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong style="color: #fff;">${ticket.name}</strong> <span style="color: #ccc;">(${ticket.email})</span><br>
                        <small style="color: #aaa;">Type: ${ticket.type} | Priority: ${ticket.priority}</small><br>
                        <small style="color: #888;">Ticket ID: ${ticket.id}</small><br>
                        <p style="color: #ddd; margin: 8px 0; font-size: 14px;">${ticket.message}</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="resolveTicket('${ticket.id}')" style="background: var(--green-neon); color: #000; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úÖ Resolve</button>
                        <button onclick="escalateTicket('${ticket.id}')" style="background: var(--red-neon); color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚ö†Ô∏è Escalate</button>
                    </div>
                </div>
            </div>`;
        });
        ticketsHtml += `</div>`;
        
        ticketsList.innerHTML = ticketsHtml;
    };
    
    window.resolveTicket = (ticketId) => {
        if (confirm('Mark this ticket as resolved?')) {
            let supportTickets = JSON.parse(localStorage.getItem('seasworth_support_tickets') || '[]');
            supportTickets = supportTickets.filter(ticket => ticket.id !== ticketId);
            localStorage.setItem('seasworth_support_tickets', JSON.stringify(supportTickets));
            loadSupportTickets();
            alert('‚úÖ Ticket resolved!');
        }
    };
    
    window.escalateTicket = (ticketId) => {
        if (confirm('Escalate this ticket to high priority?')) {
            let supportTickets = JSON.parse(localStorage.getItem('seasworth_support_tickets') || '[]');
            const ticketIndex = supportTickets.findIndex(ticket => ticket.id === ticketId);
            if (ticketIndex > -1) {
                supportTickets[ticketIndex].priority = 'High';
                supportTickets[ticketIndex].escalated = true;
                localStorage.setItem('seasworth_support_tickets', JSON.stringify(supportTickets));
                loadSupportTickets();
                alert('‚ö†Ô∏è Ticket escalated!');
            }
        }
    };

    window.logout = () => {
        sessionStorage.removeItem('seasworth_logged_in');
        sessionStorage.removeItem('seasworth_user');
        sessionStorage.removeItem('seasworth_is_admin');
        window.location.href = 'login.html';
    };

    init();
});
</script>
</body>
</html>